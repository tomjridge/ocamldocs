<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Kv_store_with_lru (tjr_kv.Tjr_kv__.Kv_store_with_lru)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">tjr_kv</a> &#x00BB; <a href="../index.html">Tjr_kv__</a> &#x00BB; Kv_store_with_lru</nav><h1>Module <code>Tjr_kv__.Kv_store_with_lru</code></h1><nav class="toc"><ul><li><a href="#architecture">Architecture</a><ul><li><a href="#queues:-q_lru_pc-and-q_pc_bt">Queues: q_lru_pc and q_pc_bt</a></li><li><a href="#blk-allocator">Blk allocator</a></li><li><a href="#lru">LRU</a></li><li><a href="#pcache">Pcache</a></li><li><a href="#b-tree">B-tree</a></li><li><a href="#root-manager">Root manager</a></li></ul></li><li><a href="#types">Types</a></li><li><a href="#factory">Factory</a></li><li><a href="#code">Code</a></li></ul></nav></header><aside><p>A KV store with an LRU cache frontend.</p></aside><section><header><h3 id="architecture"><a href="#architecture" class="anchor"></a>Architecture</h3>

<img src="https://docs.google.com/drawings/d/e/2PACX-1vTIXhyNa7dovQYXuJXBMwPQZU99-x_tRdTIH3SkMUDyPwbL31zExWXauT2hO-eRIUcnGP3RVHiSHrjt/pub?w=557&amp;h=428">

<p>We construct the following...</p></header><section><header><h4 id="queues:-q_lru_pc-and-q_pc_bt"><a href="#queues:-q_lru_pc-and-q_pc_bt" class="anchor"></a>Queues: q_lru_pc and q_pc_bt</h4><ul><li>q_lru_pc, a msg queue from the lru to the pcache</li><li>q_pc_bt, a msg queue from the pcache to the B-tree</li></ul></header></section><section><header><h4 id="blk-allocator"><a href="#blk-allocator" class="anchor"></a>Blk allocator</h4><ul><li>provides blk alloc/free</li></ul></header></section><section><header><h4 id="lru"><a href="#lru" class="anchor"></a>LRU</h4><ul><li>lru_ops, concurrent-safe map operations</li></ul></header></section><section><header><h4 id="pcache"><a href="#pcache" class="anchor"></a>Pcache</h4><ul><li>pcache_thread, which takes msgs from q_pc_bt and executes against the pcache; also performs detach occasionally and enqueues messages to q_pc_bt</li></ul></header></section><section><header><h4 id="b-tree"><a href="#b-tree" class="anchor"></a>B-tree</h4><ul><li>btree_thread, listening to q_pc_bt and executing operations against the B-tree</li></ul></header></section><section><header><h4 id="root-manager"><a href="#root-manager" class="anchor"></a>Root manager</h4><ul><li>root_man, which is responsible for persisting the roots for the B-tree and the pcache</li></ul></header></section></section><section><header><h3 id="types"><a href="#types" class="anchor"></a>Types</h3></header><dl><dt class="spec type" id="type-kv_store"><a href="#type-kv_store" class="anchor"></a><code><span class="keyword">type</span> <span>('k, 'v, 'blk_id) kv_store</span></code><code> = &lt; btree_thread : &lt; start_btree_thread : unit <span>&#45;&gt;</span> <span><span>(unit, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; &gt;; lru_ops : <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_lru_cache.mt_ops</span>; pcache_thread : &lt; start_pcache_thread : unit <span>&#45;&gt;</span> <span><span>(unit, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; &gt;; q_lru_pc : <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../Tjr_kv/Kv_intf/class-type-q_lru_pc/index.html">Tjr_kv.Kv_intf.q_lru_pc</a></span>; q_pc_bt : <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../Tjr_kv/Kv_intf/class-type-q_pc_bt/index.html">Tjr_kv.Kv_intf.q_pc_bt</a></span>; origin : <span class="type-var">'blk_id</span>; &gt;</code></dt><dd><p>NOTE the two threads have to be started before various operations can complete; the lru_ops are the operations exposed to the user</p></dd></dl></section><section><header><h3 id="factory"><a href="#factory" class="anchor"></a>Factory</h3></header><dl><dt class="spec type" id="type-kv_factory"><a href="#type-kv_factory" class="anchor"></a><code><span class="keyword">type</span> <span>('k, 'v, 'blk_id, 'blk, 'buf, 'kvop_map, 't) kv_factory</span></code><code> = &lt; pcache_factory : <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'buf</span>, <span class="type-var">'kvop_map</span>, <span class="type-var">'t</span>)</span> Tjr_pcache.pcache_factory</span>; with_ : <span>blk_dev_ops:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'blk</span>, <span class="type-var">'t</span>)</span> Tjr_fs_shared.blk_dev_ops</span></span> <span>&#45;&gt;</span> <span>freelist_ops:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> Tjr_fs_shared.Shared_freelist.freelist_ops</span></span> <span>&#45;&gt;</span> &lt; create : unit <span>&#45;&gt;</span> <span><span>(<span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'blk_id</span>)</span> <a href="index.html#type-kv_store">kv_store</a></span>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>; restore : Tjr_fs_shared.Shared_ctxt.blk_id <span>&#45;&gt;</span> <span><span>(<span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'blk_id</span>)</span> <a href="index.html#type-kv_store">kv_store</a></span>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>; &gt;; &gt;</code></dt></dl></section><section><header><h3 id="code"><a href="#code" class="anchor"></a>Code</h3></header><dl><dt class="spec value" id="val-runtime_config"><a href="#val-runtime_config" class="anchor"></a><code><span class="keyword">val</span> runtime_config : <span><a href="../../Tjr_kv/Kv_config_runtime/S/index.html#type-config">Tjr_kv.Kv_config_runtime.S.config</a> lazy_t</span></code></dt></dl><div class="spec module-type" id="module-type-S"><a href="#module-type-S" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-S/index.html">S</a> = <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Make"><a href="#module-Make" class="anchor"></a><code><span class="keyword">module</span> <a href="Make/index.html">Make</a> : <span class="keyword">functor</span> (<a href="Make/argument-1-S/index.html">S</a> : <a href="index.html#module-type-S">S</a>) <span>&#45;&gt;</span> <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section></div></body></html>
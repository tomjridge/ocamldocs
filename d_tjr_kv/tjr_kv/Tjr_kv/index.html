<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tjr_kv (tjr_kv.Tjr_kv)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">tjr_kv</a> &#x00BB; Tjr_kv</nav><h1>Module <code>Tjr_kv</code></h1><p>A key-value store (example instance)</p><h3 id="architecture"><a href="#architecture" class="anchor"></a>Architecture</h3> 

<img src="https://docs.google.com/drawings/d/e/2PACX-1vSnTmJGnVDyxnrBZ_VOVZ7T0O9etqZa-BDPu-EPH9ziiNjY375TMgO-ENB9UO4e-HT3qmtbJKvFOFl0/pub?w=453&amp;h=373">

<img src="https://docs.google.com/drawings/d/e/2PACX-1vTIXhyNa7dovQYXuJXBMwPQZU99-x_tRdTIH3SkMUDyPwbL31zExWXauT2hO-eRIUcnGP3RVHiSHrjt/pub?w=557&amp;h=428">

<p>Simplified interface:</p> 

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">module</span> <span style="color: #008000; font-weight: bold">type</span> <span style="color: #0000FF; font-weight: bold">KV</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">sig</span>
  <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>a<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m

  <span style="color: #008000; font-weight: bold">type</span> k

  <span style="color: #008000; font-weight: bold">type</span> v

  <span style="color: #008000; font-weight: bold">type</span> blk_id

  <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">)</span> kvop <span style="color: #666666">=</span> <span style="color: #0000FF; font-weight: bold">Insert</span> <span style="color: #008000; font-weight: bold">of</span> <span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">*</span> <span style="color: #008000; font-weight: bold">&#39;</span>v <span style="color: #666666">|</span> <span style="color: #0000FF; font-weight: bold">Delete</span> <span style="color: #008000; font-weight: bold">of</span> <span style="color: #008000; font-weight: bold">&#39;</span>k

  <span style="color: #408080; font-style: italic">(* NOTE this is the LRU entry type *)</span>
  <span style="color: #008000; font-weight: bold">type</span> dirty <span style="color: #666666">=</span> <span style="color: #B00040">bool</span>

  <span style="color: #008000; font-weight: bold">type</span> <span style="color: #008000; font-weight: bold">&#39;</span>v entry <span style="color: #666666">=</span>
    <span style="color: #666666">|</span> <span style="color: #0000FF; font-weight: bold">Insert</span> <span style="color: #008000; font-weight: bold">of</span> <span style="color: #666666">{</span> <span style="color: #008000; font-weight: bold">value</span> <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">;</span> dirty <span style="color: #666666">:</span> dirty <span style="color: #666666">}</span>
    <span style="color: #666666">|</span> <span style="color: #0000FF; font-weight: bold">Delete</span> <span style="color: #008000; font-weight: bold">of</span> <span style="color: #666666">{</span> dirty <span style="color: #666666">:</span> dirty <span style="color: #666666">}</span>
    <span style="color: #666666">|</span> <span style="color: #0000FF; font-weight: bold">Lower</span> <span style="color: #008000; font-weight: bold">of</span> <span style="color: #008000; font-weight: bold">&#39;</span>v option

  <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>blk_id<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> btree_ops <span style="color: #666666">=</span> <span style="color: #666666">{</span>
    find <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>v option<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">;</span>
    insert <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">&#39;</span>v <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">;</span>
    delete <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">;</span>
    sync <span style="color: #666666">:</span> <span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>blk_id<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">;</span>
  <span style="color: #666666">}</span>

  <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>blk_id<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> pc_bt_msg <span style="color: #666666">=</span>
    <span style="color: #666666">|</span> <span style="color: #0000FF; font-weight: bold">Find</span> <span style="color: #008000; font-weight: bold">of</span> <span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">*</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>v option <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">)</span>
    <span style="color: #666666">|</span> <span style="color: #0000FF; font-weight: bold">Detach</span> <span style="color: #008000; font-weight: bold">of</span> <span style="color: #666666">{</span> ops <span style="color: #666666">:</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">)</span> kvop <span style="color: #B00040">list</span><span style="color: #666666">;</span> new_pcache_root <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>blk_id <span style="color: #666666">}</span>

  <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> lru_pc_msg <span style="color: #666666">=</span>
    <span style="color: #666666">|</span> <span style="color: #0000FF; font-weight: bold">Insert</span> <span style="color: #008000; font-weight: bold">of</span> <span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">*</span> <span style="color: #008000; font-weight: bold">&#39;</span>v <span style="color: #666666">*</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">)</span>
    <span style="color: #666666">|</span> <span style="color: #0000FF; font-weight: bold">Delete</span> <span style="color: #008000; font-weight: bold">of</span> <span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">*</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">)</span>
    <span style="color: #666666">|</span> <span style="color: #0000FF; font-weight: bold">Find</span> <span style="color: #008000; font-weight: bold">of</span> <span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">*</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>v option <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">)</span>
    <span style="color: #666666">|</span> <span style="color: #0000FF; font-weight: bold">Evictees</span> <span style="color: #008000; font-weight: bold">of</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">*</span> <span style="color: #008000; font-weight: bold">&#39;</span>v entry<span style="color: #666666">)</span> <span style="color: #B00040">list</span>
        <span style="color: #408080; font-style: italic">(** NOTE this is the same as LRU msg type *)</span>

  <span style="color: #408080; font-style: italic">(* NOTE the interface provided by the key-value store is the same as</span>
<span style="color: #408080; font-style: italic">     that of the LRU component, which we reproduce here *)</span>
  <span style="color: #008000; font-weight: bold">type</span> persist_mode <span style="color: #666666">=</span> <span style="color: #0000FF; font-weight: bold">Persist_later</span> <span style="color: #666666">|</span> <span style="color: #0000FF; font-weight: bold">Persist_now</span>

  <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> mt_ops <span style="color: #666666">=</span> <span style="color: #666666">{</span>
    mt_find <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>v option<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">;</span>
    mt_insert <span style="color: #666666">:</span> persist_mode <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">&#39;</span>v <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">;</span>
    mt_delete <span style="color: #666666">:</span> persist_mode <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">;</span>
    mt_sync_key <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>k <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">;</span>
    mt_sync_all_keys <span style="color: #666666">:</span> <span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">&#39;</span>t<span style="color: #666666">)</span> m<span style="color: #666666">;</span>
  <span style="color: #666666">}</span>
<span style="color: #008000; font-weight: bold">end</span>
</pre></div>

<nav class="toc"><ul><li><a href="#main-interfaces">Main interfaces</a></li><li><a href="#configuration-and-profilers">Configuration and profilers</a></li><li><a href="#lwt-aux">Lwt aux</a></li><li><a href="#root-manager">Root manager</a></li><li><a href="#btree-thread">Btree thread</a></li><li><a href="#pcache-thread">Pcache thread</a></li><li><a href="#lru">Lru</a></li><li><a href="#the-key-value-store">The key-value store</a></li><li><a href="#further-notes">Further notes</a><ul><li><a href="#combining-b-tree-and-pcache-roots-in-a-single-block">Combining B-tree and pcache roots in a single block</a></li></ul></li></ul></nav></header><aside><p>See <a href="Kv_store_with_lru/index.html"><code>Kv_store_with_lru</code></a> for more details</p></aside><section><header><h3 id="main-interfaces"><a href="#main-interfaces" class="anchor"></a>Main interfaces</h3></header><div class="spec module" id="module-Kv_intf"><a href="#module-Kv_intf" class="anchor"></a><code><span class="keyword">module</span> <a href="Kv_intf/index.html">Kv_intf</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec module" id="module-Kv_intf_v2"><a href="#module-Kv_intf_v2" class="anchor"></a><code><span class="keyword">module</span> <a href="Kv_intf_v2/index.html">Kv_intf_v2</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Interfaces based on classes</p></dd></dl></section><section><header><h3 id="configuration-and-profilers"><a href="#configuration-and-profilers" class="anchor"></a>Configuration and profilers</h3></header><div class="spec module" id="module-Kv_config_optcomp"><a href="#module-Kv_config_optcomp" class="anchor"></a><code><span class="keyword">module</span> <a href="Kv_config_optcomp/index.html">Kv_config_optcomp</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Kv_config_runtime"><a href="#module-Kv_config_runtime" class="anchor"></a><code><span class="keyword">module</span> <a href="Kv_config_runtime/index.html">Kv_config_runtime</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Kv_config_profilers"><a href="#module-Kv_config_profilers" class="anchor"></a><code><span class="keyword">module</span> <a href="Kv_config_profilers/index.html">Kv_config_profilers</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section><section><header><h3 id="lwt-aux"><a href="#lwt-aux" class="anchor"></a>Lwt aux</h3></header><dl><dt class="spec module" id="module-Lwt_aux"><a href="#module-Lwt_aux" class="anchor"></a><code><span class="keyword">module</span> <a href="Lwt_aux/index.html">Lwt_aux</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Lwt support FIXME move to shared? or tjr_monad?</p></dd></dl></section><section><header><h3 id="root-manager"><a href="#root-manager" class="anchor"></a>Root manager</h3></header><dl><dt class="spec module" id="module-Root_manager"><a href="#module-Root_manager" class="anchor"></a><code><span class="keyword">module</span> <a href="Root_manager/index.html">Root_manager</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd></dd></dl></section><section><header><h3 id="btree-thread"><a href="#btree-thread" class="anchor"></a>Btree thread</h3></header><dl><dt class="spec module" id="module-Btree_thread"><a href="#module-Btree_thread" class="anchor"></a><code><span class="keyword">module</span> <a href="Btree_thread/index.html">Btree_thread</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>The B-tree worker thread</p></dd></dl></section><section><header><h3 id="pcache-thread"><a href="#pcache-thread" class="anchor"></a>Pcache thread</h3></header><dl><dt class="spec module" id="module-Pcache_thread"><a href="#module-Pcache_thread" class="anchor"></a><code><span class="keyword">module</span> <a href="Pcache_thread/index.html">Pcache_thread</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Pcache worker thread</p></dd></dl></section><section><header><h3 id="lru"><a href="#lru" class="anchor"></a>Lru</h3></header><dl><dt class="spec module" id="module-Lru"><a href="#module-Lru" class="anchor"></a><code><span class="keyword">module</span> <a href="Lru/index.html">Lru</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>The LRU</p></dd></dl></section><section><header><h3 id="the-key-value-store"><a href="#the-key-value-store" class="anchor"></a>The key-value store</h3></header><dl><dt class="spec module" id="module-Kv_store_with_lru"><a href="#module-Kv_store_with_lru" class="anchor"></a><code><span class="keyword">module</span> <a href="Kv_store_with_lru/index.html">Kv_store_with_lru</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>A KV store with an LRU cache frontend.</p></dd></dl></section><section><header><h3 id="further-notes"><a href="#further-notes" class="anchor"></a>Further notes</h3></header><section><header><h4 id="combining-b-tree-and-pcache-roots-in-a-single-block"><a href="#combining-b-tree-and-pcache-roots-in-a-single-block" class="anchor"></a>Combining B-tree and pcache roots in a single block</h4><p>One option when syncing the btree+pcache combination would be to write the pcache roots to disk, and then (in another block) write the B-tree root. This is fine, but if a crash occurs inbetween, we have to recover (which isn't difficult, but still adds complexity). As an alternative, we can write the btree and the pcache roots into the same block atomically. This means that we don't have to worry about recovering from a crash (this approach is crash safe by design).</p></header></section></section></div></body></html>
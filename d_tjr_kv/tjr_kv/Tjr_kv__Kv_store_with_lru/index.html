<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tjr_kv__Kv_store_with_lru (tjr_kv.Tjr_kv__Kv_store_with_lru)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../index.html">tjr_kv</a> &#x00BB; Tjr_kv__Kv_store_with_lru</nav><h1>Module <code>Tjr_kv__Kv_store_with_lru</code></h1><p>A KV store with an LRU cache frontend.</p><nav class="toc"><ul><li><a href="#architecture">Architecture</a><ul><li><a href="#queues:-q_lru_pc-and-q_pc_bt">Queues: q_lru_pc and q_pc_bt</a></li><li><a href="#blk-allocator">Blk allocator</a></li><li><a href="#lru">LRU</a></li><li><a href="#pcache">Pcache</a></li><li><a href="#b-tree">B-tree</a></li><li><a href="#root-manager">Root manager</a></li></ul></li><li><a href="#code">Code</a></li></ul></nav></header><section><header><h3 id="architecture"><a href="#architecture" class="anchor"></a>Architecture</h3> 

<img src="https://docs.google.com/drawings/d/e/2PACX-1vTIXhyNa7dovQYXuJXBMwPQZU99-x_tRdTIH3SkMUDyPwbL31zExWXauT2hO-eRIUcnGP3RVHiSHrjt/pub?w=557&amp;h=428">

<p>We construct the following...</p></header><section><header><h4 id="queues:-q_lru_pc-and-q_pc_bt"><a href="#queues:-q_lru_pc-and-q_pc_bt" class="anchor"></a>Queues: q_lru_pc and q_pc_bt</h4><ul><li>q_lru_pc, a msg queue from the lru to the pcache</li><li>q_pc_bt, a msg queue from the pcache to the B-tree</li></ul></header></section><section><header><h4 id="blk-allocator"><a href="#blk-allocator" class="anchor"></a>Blk allocator</h4><ul><li>provides blk alloc/free</li></ul></header></section><section><header><h4 id="lru"><a href="#lru" class="anchor"></a>LRU</h4><ul><li>lru_ops, concurrent-safe map operations</li></ul></header></section><section><header><h4 id="pcache"><a href="#pcache" class="anchor"></a>Pcache</h4><ul><li>pcache_thread, which takes msgs from q_pc_bt and executes against the pcache; also performs detach occasionally and enqueues messages to q_pc_bt</li></ul></header></section><section><header><h4 id="b-tree"><a href="#b-tree" class="anchor"></a>B-tree</h4><ul><li>btree_thread, listening to q_pc_bt and executing operations against the B-tree</li></ul></header></section><section><header><h4 id="root-manager"><a href="#root-manager" class="anchor"></a>Root manager</h4><ul><li>root_man, which is responsible for persisting the roots for the B-tree and the pcache</li></ul></header></section></section><section><header><h3 id="code"><a href="#code" class="anchor"></a>Code</h3></header><dl><dt class="spec value" id="val-runtime_config"><a href="#val-runtime_config" class="anchor"></a><code><span class="keyword">val</span> runtime_config : <span><a href="../Tjr_kv/Kv_config_runtime/S/index.html#type-config">Tjr_kv.Kv_config_runtime.S.config</a> lazy_t</span></code></dt></dl><dl><dt class="spec type" id="type-rt_blk"><a href="#type-rt_blk" class="anchor"></a><code><span class="keyword">type</span> rt_blk</code><code> = </code><code>{</code><table class="record"><tr id="type-rt_blk.bt_rt" class="anchored"><td class="def field"><a href="#type-rt_blk.bt_rt" class="anchor"></a><code><span class="keyword">mutable</span> bt_rt : Tjr_fs_shared.Std_types.blk_id;</code></td></tr><tr id="type-rt_blk.pc_hd" class="anchored"><td class="def field"><a href="#type-rt_blk.pc_hd" class="anchor"></a><code><span class="keyword">mutable</span> pc_hd : Tjr_fs_shared.Std_types.blk_id;</code></td></tr><tr id="type-rt_blk.pc_tl" class="anchored"><td class="def field"><a href="#type-rt_blk.pc_tl" class="anchor"></a><code><span class="keyword">mutable</span> pc_tl : Tjr_fs_shared.Std_types.blk_id;</code></td></tr></table><code>}</code></dt><dt class="spec type" id="type-min_free"><a href="#type-min_free" class="anchor"></a><code><span class="keyword">type</span> min_free</code><code> = </code><code>{</code><table class="record"><tr id="type-min_free.min_free_blk_id" class="anchored"><td class="def field"><a href="#type-min_free.min_free_blk_id" class="anchor"></a><code><span class="keyword">mutable</span> min_free_blk_id : Tjr_fs_shared.Std_types.blk_id;</code></td></tr></table><code>}</code></dt><dt class="spec type" id="type-kv_store"><a href="#type-kv_store" class="anchor"></a><code><span class="keyword">type</span> <span>('k, 'v) kv_store</span></code><code> = &lt; blk_alloc : <span><span>(Tjr_fs_shared.Std_types.r, Tjr_fs_shared.Std_types.t)</span> Tjr_fs_shared.blk_allocator_ops</span>; btree_thread : &lt; start_btree_thread : unit <span>&#45;&gt;</span> <span><span>(unit, Tjr_fs_shared.Std_types.t)</span> Tjr_monad.m</span>; &gt;; lru_ops : <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, Tjr_fs_shared.Std_types.t)</span> Tjr_lru_cache.Mt_intf.mt_ops</span>; min_free : <a href="index.html#type-min_free">min_free</a>; pcache_thread : &lt; start_pcache_thread : unit <span>&#45;&gt;</span> <span><span>(unit, Tjr_fs_shared.Std_types.t)</span> Tjr_monad.m</span>; &gt;; q_lru_pc : <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, Tjr_fs_shared.Std_types.t)</span> <a href="../Tjr_kv/Kv_intf/class-type-q_lru_pc/index.html">Tjr_kv.Kv_intf.q_lru_pc</a></span>; q_pc_bt : <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, Tjr_fs_shared.Std_types.t)</span> <a href="../Tjr_kv/Kv_intf/class-type-q_pc_bt/index.html">Tjr_kv.Kv_intf.q_pc_bt</a></span>; root_man : <span><span>(<a href="index.html#type-rt_blk">rt_blk</a>, Tjr_fs_shared.Std_types.t)</span> <a href="../Tjr_kv/Kv_intf/class-type-root_man/index.html">Tjr_kv.Kv_intf.root_man</a></span>; rt_blk : <a href="index.html#type-rt_blk">rt_blk</a>; &gt;</code></dt><dd><pre><code class="ml">type ('k,'v) kv_store = &lt;
  blk_alloc     : (r, t) blk_allocator_ops;
  btree_thread  : &lt; start_btree_thread : unit -&gt; (unit, t)m &gt;;
  lru_ops       : ('k, 'v, t) mt_ops;
  min_free      : min_free;
  pcache_thread : &lt; start_pcache_thread : unit -&gt; (unit, t)m &gt;;
  q_lru_pc      : ('k, 'v) q_lru_pc;
  q_pc_bt       : ('k, 'v) q_pc_bt;
  root_man      : rt_blk root_man; 
  rt_blk        : rt_blk 
&gt;</code></pre></dd></dl><div class="spec module-type" id="module-type-S"><a href="#module-type-S" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-S/index.html">S</a> = <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Make"><a href="#module-Make" class="anchor"></a><code><span class="keyword">module</span> <a href="Make/index.html">Make</a> : <span class="keyword">functor</span> (<a href="Make/argument-1-S/index.html">S</a> : <a href="index.html#module-type-S">S</a>) <span>&#45;&gt;</span> <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Int_int_ex"><a href="#module-Int_int_ex" class="anchor"></a><code><span class="keyword">module</span> <a href="Int_int_ex/index.html">Int_int_ex</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section></div></body></html>
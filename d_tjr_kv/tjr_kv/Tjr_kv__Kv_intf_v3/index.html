<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tjr_kv__Kv_intf_v3 (tjr_kv.Tjr_kv__Kv_intf_v3)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">tjr_kv</a> &#x00BB; Tjr_kv__Kv_intf_v3</nav><h1>Module <code>Tjr_kv__Kv_intf_v3</code></h1><p>Interfaces based on a single &quot;store&quot; object with mutable refs.</p><p>NOTE the class types are not rendered well with odoc.</p>


<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>  <span style="color: #008000; font-weight: bold">class</span> <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">[</span><span style="color: #008000; font-weight: bold">&#39;</span>a<span style="color: #666666">]</span> mrshlr <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">object</span>
    <span style="color: #008000; font-weight: bold">method</span> to_blk<span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>a <span style="color: #666666">-&gt;</span> blk
    <span style="color: #008000; font-weight: bold">method</span> of_blk<span style="color: #666666">:</span> blk <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">&#39;</span>a
  <span style="color: #008000; font-weight: bold">end</span>

  <span style="color: #008000; font-weight: bold">class</span> <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">[</span><span style="color: #008000; font-weight: bold">&#39;</span>a<span style="color: #666666">]</span> set_once <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">object</span>
    <span style="color: #008000; font-weight: bold">method</span> set<span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>a <span style="color: #666666">-&gt;</span> <span style="color: #B00040">unit</span>
    <span style="color: #008000; font-weight: bold">method</span> get<span style="color: #666666">:</span> <span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">&#39;</span>a
    <span style="color: #008000; font-weight: bold">method</span> is_set<span style="color: #666666">:</span> <span style="color: #B00040">bool</span>
  <span style="color: #008000; font-weight: bold">end</span>

  <span style="color: #008000; font-weight: bold">class</span> <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">[</span><span style="color: #008000; font-weight: bold">&#39;</span>a<span style="color: #666666">]</span> mutable_ <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">object</span>
    <span style="color: #008000; font-weight: bold">method</span> set<span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>a <span style="color: #666666">-&gt;</span> <span style="color: #B00040">unit</span>
    <span style="color: #008000; font-weight: bold">method</span> get<span style="color: #666666">:</span> <span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">&#39;</span>a
    <span style="color: #008000; font-weight: bold">method</span> is_set<span style="color: #666666">:</span> <span style="color: #B00040">bool</span>
  <span style="color: #008000; font-weight: bold">end</span>

  <span style="color: #408080; font-style: italic">(** This is a container for a type &#39;a that can be stored in a single</span>
<span style="color: #408080; font-style: italic">     block. The initialized method checks that all the state parts of</span>
<span style="color: #408080; font-style: italic">     a component are initialized; use with assert *)</span>
  <span style="color: #008000; font-weight: bold">class</span> <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">[</span><span style="color: #008000; font-weight: bold">&#39;</span>a<span style="color: #666666">]</span> on_disk_block <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">object</span>
    <span style="color: #008000; font-weight: bold">val</span> blk_dev_ops    <span style="color: #666666">:</span> <span style="color: #666666">(</span>blk_id<span style="color: #666666">,</span>blk<span style="color: #666666">,</span>t<span style="color: #666666">)</span>blk_dev_ops set_once
    <span style="color: #008000; font-weight: bold">val</span> blk_id         <span style="color: #666666">:</span> blk_id set_once
    <span style="color: #008000; font-weight: bold">val</span> contents       <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>a mutable_
    <span style="color: #008000; font-weight: bold">val</span> marshaller     <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>a mrshlr set_once
    <span style="color: #008000; font-weight: bold">method</span> sync_to_disk   <span style="color: #666666">:</span> <span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span>t<span style="color: #666666">)</span>m
    <span style="color: #008000; font-weight: bold">method</span> sync_from_disk <span style="color: #666666">:</span> <span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span>t<span style="color: #666666">)</span>m
    <span style="color: #008000; font-weight: bold">method</span> is_initialized <span style="color: #666666">:</span> <span style="color: #B00040">bool</span>
  <span style="color: #008000; font-weight: bold">end</span>

  <span style="color: #008000; font-weight: bold">class</span> <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">[</span><span style="color: #008000; font-weight: bold">&#39;</span>fl<span style="color: #666666">]</span> freelist <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">object</span>
    <span style="color: #008000; font-weight: bold">inherit</span> <span style="color: #666666">[</span><span style="color: #008000; font-weight: bold">&#39;</span>fl<span style="color: #666666">]</span> on_disk_block
    <span style="color: #008000; font-weight: bold">method</span> blk_allocator<span style="color: #666666">:</span> <span style="color: #666666">(</span>r<span style="color: #666666">,</span>t<span style="color: #666666">)</span>blk_allocator_ops
  <span style="color: #008000; font-weight: bold">end</span>

  <span style="color: #008000; font-weight: bold">type</span> t1 <span style="color: #666666">=</span> <span style="color: #666666">{</span> 
    <span style="color: #008000; font-weight: bold">mutable</span> bt_rt<span style="color: #666666">:</span>blk_id<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">mutable</span> pc_hd<span style="color: #666666">:</span>blk_id<span style="color: #666666">;</span> 
    <span style="color: #008000; font-weight: bold">mutable</span> pc_tl<span style="color: #666666">:</span>blk_id 
  <span style="color: #666666">}[@@</span>deriving bin_io<span style="color: #666666">]</span>

  <span style="color: #008000; font-weight: bold">class</span> <span style="color: #008000; font-weight: bold">type</span> root_man <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">object</span>
    <span style="color: #008000; font-weight: bold">inherit</span> <span style="color: #666666">[</span>t1<span style="color: #666666">]</span> on_disk_block
  <span style="color: #008000; font-weight: bold">end</span>

  <span style="color: #408080; font-style: italic">(* we expect that, once setup, the threads run forever; other</span>
<span style="color: #408080; font-style: italic">     applications may need to shutdown threads instead. *)</span> 
  <span style="color: #008000; font-weight: bold">class</span> <span style="color: #008000; font-weight: bold">type</span> btree <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">object</span>
    <span style="color: #008000; font-weight: bold">method</span> blk_dev_ops    <span style="color: #666666">:</span> <span style="color: #666666">(</span>blk_id<span style="color: #666666">,</span>blk<span style="color: #666666">,</span>t<span style="color: #666666">)</span>blk_dev_ops set_once
    <span style="color: #008000; font-weight: bold">method</span> blk_id         <span style="color: #666666">:</span> blk_id mutable_ <span style="color: #408080; font-style: italic">(* root of the btree *)</span>
    <span style="color: #008000; font-weight: bold">method</span> thread         <span style="color: #666666">:</span> <span style="color: #666666">&lt;</span> start_thread<span style="color: #666666">:</span> <span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span>t<span style="color: #666666">)</span>m <span style="color: #666666">&gt;</span>
    <span style="color: #008000; font-weight: bold">method</span> btree_ops      <span style="color: #666666">:</span> <span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">,</span>blk_id<span style="color: #666666">,</span>t<span style="color: #666666">)</span> <span style="color: #0000FF; font-weight: bold">Kv_intf</span>.<span style="color: #0000FF; font-weight: bold">Btree_ops</span>.btree_ops
    <span style="color: #008000; font-weight: bold">method</span> is_initialized <span style="color: #666666">:</span> <span style="color: #B00040">bool</span>

    <span style="color: #408080; font-style: italic">(** Flush the write back cache, after merging a prefix of the pcache *)</span>
    <span style="color: #008000; font-weight: bold">method</span> flush_cache    <span style="color: #666666">:</span> <span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span>t<span style="color: #666666">)</span>m
  <span style="color: #008000; font-weight: bold">end</span>

  <span style="color: #008000; font-weight: bold">class</span> <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">[</span><span style="color: #008000; font-weight: bold">&#39;</span>kvop_map<span style="color: #666666">]</span> pcache <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">object</span>
    <span style="color: #008000; font-weight: bold">method</span> blk_dev_ops    <span style="color: #666666">:</span> <span style="color: #666666">(</span>blk_id<span style="color: #666666">,</span>blk<span style="color: #666666">,</span>t<span style="color: #666666">)</span>blk_dev_ops set_once
    <span style="color: #008000; font-weight: bold">method</span> pcache_state   <span style="color: #666666">:</span> <span style="color: #666666">(</span>r<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>kvop_map<span style="color: #666666">)</span> <span style="color: #0000FF; font-weight: bold">Tjr_pcache</span>.<span style="color: #0000FF; font-weight: bold">Pcache_state</span>.pcache_state mutable_
    <span style="color: #008000; font-weight: bold">method</span> thread         <span style="color: #666666">:</span> <span style="color: #666666">&lt;</span> start_thread<span style="color: #666666">:</span> <span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span>t<span style="color: #666666">)</span>m <span style="color: #666666">&gt;</span>
    <span style="color: #008000; font-weight: bold">method</span> sync_to_disk   <span style="color: #666666">:</span> <span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span>t<span style="color: #666666">)</span>m
    <span style="color: #008000; font-weight: bold">method</span> sync_from_disk <span style="color: #666666">:</span> hd<span style="color: #666666">:</span>blk_id <span style="color: #666666">-&gt;</span> tl<span style="color: #666666">:</span>blk_id <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #B00040">unit</span><span style="color: #666666">,</span>t<span style="color: #666666">)</span>m
    <span style="color: #008000; font-weight: bold">method</span> is_initialized <span style="color: #666666">:</span> <span style="color: #B00040">bool</span>
  <span style="color: #008000; font-weight: bold">end</span>

  <span style="color: #008000; font-weight: bold">class</span> <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">[</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>mt_state<span style="color: #666666">]</span> lru <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">object</span>
    <span style="color: #008000; font-weight: bold">method</span> get_lru_state<span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>mt_state mutable_
    <span style="color: #008000; font-weight: bold">method</span> lru_ops<span style="color: #666666">:</span> <span style="color: #B00040">unit</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">,</span>t<span style="color: #666666">)</span>mt_ops
  <span style="color: #008000; font-weight: bold">end</span>
  
  <span style="color: #408080; font-style: italic">(** A collection of all the stateful components *)</span>
  <span style="color: #008000; font-weight: bold">class</span> <span style="color: #008000; font-weight: bold">type</span> <span style="color: #666666">[</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>fl<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>kvop_map<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>mt_state<span style="color: #666666">]</span> kv_store <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">object</span>
    <span style="color: #008000; font-weight: bold">method</span> root_man <span style="color: #666666">:</span> root_man 
    <span style="color: #008000; font-weight: bold">method</span> btree    <span style="color: #666666">:</span> btree
    <span style="color: #008000; font-weight: bold">method</span> q_pc_bt  <span style="color: #666666">:</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">)</span> <span style="color: #0000FF; font-weight: bold">Kv_intf_v2</span>.q_pc_bt
    <span style="color: #008000; font-weight: bold">method</span> pcache   <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">&#39;</span>kvop_map pcache
    <span style="color: #008000; font-weight: bold">method</span> q_lru_pc <span style="color: #666666">:</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">)</span> <span style="color: #0000FF; font-weight: bold">Kv_intf_v2</span>.q_lru_pc
    <span style="color: #008000; font-weight: bold">method</span> lru      <span style="color: #666666">:</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">&#39;</span>k<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>v<span style="color: #666666">,</span><span style="color: #008000; font-weight: bold">&#39;</span>mt_state<span style="color: #666666">)</span> lru

    <span style="color: #408080; font-style: italic">(** Checks all components are initialized *)</span>
    <span style="color: #008000; font-weight: bold">method</span> is_initialized <span style="color: #666666">:</span> <span style="color: #B00040">bool</span>
  <span style="color: #008000; font-weight: bold">end</span>
</pre></div>


</header><div class="spec module" id="module-Pvt_class_types"><a href="#module-Pvt_class_types" class="anchor"></a><code><span class="keyword">module</span> <a href="Pvt_class_types/index.html">Pvt_class_types</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Classes"><a href="#module-Classes" class="anchor"></a><code><span class="keyword">module</span> <a href="Classes/index.html">Classes</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include</span> <a href="index.html#module-Classes">Classes</a></code></span></summary><div class="spec module" id="module-P"><a href="#module-P" class="anchor"></a><code><span class="keyword">module</span> P = <a href="index.html#module-Pvt_class_types">Pvt_class_types</a></code></div><section><header><h3 id="generic-syncable-object"><a href="#generic-syncable-object" class="anchor"></a>Generic syncable object</h3></header><div class="spec module" id="module-Make_mrshlr"><a href="#module-Make_mrshlr" class="anchor"></a><code><span class="keyword">module</span> Make_mrshlr = <a href="Classes/index.html#module-Make_mrshlr">Classes.Make_mrshlr</a></code></div><div class="spec class" id="class-mutable_"><a href="#class-mutable_" class="anchor"></a><code><span class="keyword">class</span> +'b <a href="class-mutable_/index.html">mutable_</a> : <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><div class="spec class" id="class-set_once"><a href="#class-set_once" class="anchor"></a><code><span class="keyword">class</span> +'b <a href="class-set_once/index.html">set_once</a> : <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><div class="spec class" id="class-on_disk_block"><a href="#class-on_disk_block" class="anchor"></a><code><span class="keyword">class</span> 'a <a href="class-on_disk_block/index.html">on_disk_block</a> : <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec value" id="val-f"><a href="#val-f" class="anchor"></a><code><span class="keyword">val</span> f : <span><span class="type-var">'a</span> <a href="class-on_disk_block/index.html">on_disk_block</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="Pvt_class_types/class-type-on_disk_block/index.html">P.on_disk_block</a></span></code></dt></dl></section></details></div></div></div></div></body></html>
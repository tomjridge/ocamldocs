<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tjr_profile (tjr_profile.Tjr_profile)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">tjr_profile</a> &#x00BB; Tjr_profile</nav><header class="odoc-preamble"><h1>Module <code><span>Tjr_profile</span></code></h1><p>Profiling is controlled via optcomp flags. The <code>Optcomp_config</code> module records those values as OCaml values.</p><p>Example (see Example module in Tjr_profile):</p><pre><code>let f () = 
  (* do something *)
  1+2

(** waypoint *)
let pt = intern &quot;pt&quot;

let profiler = make_profiler ()
let {mark;_} = profiler

let profiled_f () = 
  mark pt;
  let r = f () in
  mark (-1*pt);
  r

(** Run f 100 times, and print the profiling results at exit *)
let do_it () = 
  for i = 0 to 100 do
    ignore(profiled_f())
  done</code></pre></header><nav class="odoc-toc"><ul><li><a href="#configuation">Configuation</a></li><li><a href="#interface">Interface</a></li><li><a href="#profile-a-single-function">Profile a single function</a></li><li><a href="#example">Example</a></li></ul></nav><div class="odoc-content"><h3 id="configuation"><a href="#configuation" class="anchor"></a>Configuation</h3><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <span class="keyword">struct</span> <span class="keyword">include</span> <a href="../Tjr_profile_core/Optcomp_config/index.html">Tjr_profile_core.Optcomp_config</a> <span class="keyword">end</span></span></code></summary><p>This is an optcomp configuration file. It imports a raw optcomp file from &quot;config.ml&quot; which defines two optcomp variables: PROFILING_USE_TSC and PROFILING_ENABLED. The rest of the file is optcomp-filtered OCaml.</p><p>The underlying timing method is controlled by optcomp <code>PROFILING_USE_TSC</code> variable.</p><div class="odoc-spec"><div class="spec value" id="val-profiling_use_tsc" class="anchored"><a href="#val-profiling_use_tsc" class="anchor"></a><code><span><span class="keyword">val</span> profiling_use_tsc : bool</span></code></div><div class="spec-doc"><p>We ARE using TSC for profiling.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-now" class="anchored"><a href="#val-now" class="anchor"></a><code><span><span class="keyword">val</span> now : <span>unit <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-profiling_enabled" class="anchored"><a href="#val-profiling_enabled" class="anchor"></a><code><span><span class="keyword">val</span> profiling_enabled : bool</span></code></div><div class="spec-doc"><p>Profiling IS enabled (for profilers)</p></div></div></details></div><h3 id="interface"><a href="#interface" class="anchor"></a>Interface</h3><div class="odoc-spec"><div class="spec module" id="module-Profile_intf" class="anchored"><a href="#module-Profile_intf" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Profile_intf/index.html">Profile_intf</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Profiling interfaces</p></div></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <span class="keyword">struct</span> <span class="keyword">include</span> <a href="Profile_intf/index.html">Profile_intf</a> <span class="keyword">end</span></span></code></summary><div class="odoc-spec"><div class="spec type" id="type-profiler" class="anchored"><a href="#type-profiler" class="anchor"></a><code><span><span class="keyword">type</span> <span>'waypoint profiler</span></span><span> = </span><span>{</span></code><table><tr id="type-profiler.mark" class="anchored"><td class="def record field"><a href="#type-profiler.mark" class="anchor"></a><code><span>mark : <span><span class="type-var">'waypoint</span> <span class="arrow">&#45;&gt;</span></span> unit;</span></code></td></tr><tr id="type-profiler.get_marks" class="anchored"><td class="def record field"><a href="#type-profiler.get_marks" class="anchor"></a><code><span>get_marks : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'waypoint</span> * int)</span> list</span>;</span></code></td></tr><tr id="type-profiler.print_summary" class="anchored"><td class="def record field"><a href="#type-profiler.print_summary" class="anchor"></a><code><span>print_summary : <span>unit <span class="arrow">&#45;&gt;</span></span> unit;</span></code></td></tr><tr id="type-profiler.time_thunk" class="anchored"><td class="def record field"><a href="#type-profiler.time_thunk" class="anchor"></a><code><span>time_thunk : a. <span><span class="type-var">'waypoint</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>Profiler ops:</p><ul><li>mark: imperative mark command</li><li>(pvt) get_marks: a list of all marked waypoints and the corresponding times at which they were marked</li><li>print_summary: print a human-readable summary (see <code>Pretty_print</code>)</li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-dummy_profiler" class="anchored"><a href="#val-dummy_profiler" class="anchor"></a><code><span><span class="keyword">val</span> dummy_profiler : <span><span class="type-var">'a</span> <a href="#type-profiler">profiler</a></span></span></code></div></div><div class="odoc-spec"><div class="spec exception" id="exception-Profiling_exception" class="anchored"><a href="#exception-Profiling_exception" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Profiling_exception</span> <span class="keyword">of</span> string</span></code></div></div></details></div><div class="odoc-spec"><div class="spec module" id="module-With_array" class="anchored"><a href="#module-With_array" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="With_array/index.html">With_array</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>This version attempts to reduce computation and GC costs during the profiling (there may be substantial processing costs at the end to compute the summary).</p></div></div><div class="odoc-spec"><div class="spec value" id="val-make_profiler" class="anchored"><a href="#val-make_profiler" class="anchor"></a><code><span><span class="keyword">val</span> make_profiler : <span>?print_header:string <span class="arrow">&#45;&gt;</span></span> <span>?cap:int <span class="arrow">&#45;&gt;</span></span> <span>?print_at_exit:bool <span class="arrow">&#45;&gt;</span></span>
<span>unit <span class="arrow">&#45;&gt;</span></span> <span>int <span class="xref-unresolved">Tjr_profile__Intf_.profiler</span></span></span></code></div><div class="spec-doc"><p>By default, we use the array-based profiler</p></div></div><div class="odoc-spec"><div class="spec value" id="val-intern" class="anchored"><a href="#val-intern" class="anchor"></a><code><span><span class="keyword">val</span> intern : <span>string <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Waypoints are int (for efficiency); strings can be interned to convert them to ints; when interning a string &quot;foo&quot;, we also intern the string &quot;foo'&quot; as the negative of the intern of foo; this allows a common &quot;entry/exit&quot; idiom</p></div></div><h3 id="profile-a-single-function"><a href="#profile-a-single-function" class="anchor"></a>Profile a single function</h3><div class="odoc-spec"><div class="spec module" id="module-Profile_single_function" class="anchored"><a href="#module-Profile_single_function" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Profile_single_function/index.html">Profile_single_function</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Profile a single function which may be called many times, using &quot;enter&quot; and &quot;exit&quot;. This code keeps track of the number of times, and the total time.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-measure_execution_time_and_print" class="anchored"><a href="#val-measure_execution_time_and_print" class="anchor"></a><code><span><span class="keyword">val</span> measure_execution_time_and_print : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Measure execution time, and print result on output immediately. This is not affected by optcomp config.</p></div></div><h3 id="example"><a href="#example" class="anchor"></a>Example</h3><div class="odoc-spec"><div class="spec module" id="module-Example" class="anchored"><a href="#module-Example" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Example/index.html">Example</a></span><span> () : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
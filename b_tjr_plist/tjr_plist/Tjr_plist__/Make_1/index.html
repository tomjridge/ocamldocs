<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Make_1 (tjr_plist.Tjr_plist__.Make_1)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">tjr_plist</a> &#x00BB; <a href="../index.html">Tjr_plist__</a> &#x00BB; Make_1</nav><h1>Module <code>Tjr_plist__.Make_1</code></h1><nav class="toc"><ul><li><a href="#examples">examples</a></li></ul></nav></header><aside><p>Construct a persistent list (most generic version, not concurrent-safe).</p><p>We store the list of elts from offset off0 (say); the nxt pointer takes up the first off0 bytes. Assumes max size of marshalled blk_ptr is off0 bytes.</p><p>When an elt is added, we marshal to buffer immediately (same for nxt pointer). Only when we write to disk do we update the buffer with the None pointer.</p><p>The idea is to make an on-disk list structure that can be updated extremely quickly (one block write and one barrier in the common case, without having to udpate the origin since we can just follow tl pointers).</p><p>Plist block structure:</p>
<img width='100%' src="https://docs.google.com/drawings/d/e/2PACX-1vS3avt7A5v-_ormHZlUYMIjUtOQ63U5tL4nDgHkIVI8VXqraTu6ClOCmYcMy3HeS5dCT-6LYpAYFgAC/pub?w=1033&amp;h=312">
<p>Some invariants:</p><ul><li>adding an element, or setting the nxt pointer, marshals immediately</li><li>the EOL marker is only marshalled when syncing the tl block (presumably to avoid repeated marshalling of this marker? seems premature)</li></ul></aside><div class="spec module-type" id="module-type-S"><a href="#module-type-S" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-S/index.html">S</a> = <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module-type" id="module-type-T"><a href="#module-type-T" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-T/index.html">T</a> = <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Make_v1"><a href="#module-Make_v1" class="anchor"></a><code><span class="keyword">module</span> <a href="Make_v1/index.html">Make_v1</a> : <span class="keyword">functor</span> (<a href="Make_v1/argument-1-S/index.html">S</a> : <a href="index.html#module-type-S">S</a>) <span>&#45;&gt;</span> <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec module" id="module-Make_v2"><a href="#module-Make_v2" class="anchor"></a><code><span class="keyword">module</span> <a href="Make_v2/index.html">Make_v2</a> : <span class="keyword">functor</span> (<a href="Make_v2/argument-1-S/index.html">S</a> : <a href="index.html#module-type-S">S</a>) <span>&#45;&gt;</span> <a href="index.html#module-type-T">T</a> <span class="keyword">with</span> <span class="keyword">module</span> <a href="Make_v2/S/index.html">S</a> = <a href="Make_v2/index.html#argument-1-S">S</a></code></dt><dd><p>Like Make_v1 but with restricted sig</p></dd></dl><dl><dt class="spec value" id="val-make"><a href="#val-make" class="anchor"></a><code><span class="keyword">val</span> make : <span>buf_ops:<span><span class="type-var">'buf</span> Tjr_fs_shared.buf_ops</span></span> <span>&#45;&gt;</span> <span>blk_ops:<span><span>(<span class="type-var">'blk</span>, <span class="type-var">'buf</span>)</span> Tjr_fs_shared.blk_ops</span></span> <span>&#45;&gt;</span> <span>plist_marshal_info:<span><span>(<span class="type-var">'a</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'blk</span>, <span class="type-var">'buf</span>)</span> <a href="../../Tjr_plist/Plist_intf/index.html#type-plist_marshal_info">Tjr_plist.Plist_intf.plist_marshal_info</a></span></span> <span>&#45;&gt;</span> <span>monad_ops:<span><span class="type-var">'t</span> Tjr_monad.monad_ops</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'blk</span>, <span class="type-var">'buf</span>, <span class="type-var">'t</span>)</span> <a href="../../Tjr_plist/Plist_intf/index.html#type-plist_factory">Tjr_plist.Plist_intf.plist_factory</a></span></code></dt><dd><p>Version without functor</p></dd></dl><section><header><h3 id="examples"><a href="#examples" class="anchor"></a>examples</h3></header><dl><dt class="spec value" id="val-pl_examples"><a href="#val-pl_examples" class="anchor"></a><code><span class="keyword">val</span> pl_examples : &lt; for_blk_id : <span>Tjr_fs_shared.Shared_ctxt.r <a href="../../Tjr_plist/Pl_type_abbrevs/index.html#type-plist_factory">Tjr_plist.Pl_type_abbrevs.plist_factory</a></span>; for_int : <span>int <a href="../../Tjr_plist/Pl_type_abbrevs/index.html#type-plist_factory">Tjr_plist.Pl_type_abbrevs.plist_factory</a></span>; for_int_int_kvop : <span><span><span>(int, int)</span> Tjr_fs_shared.kvop</span> <a href="../../Tjr_plist/Pl_type_abbrevs/index.html#type-plist_factory">Tjr_plist.Pl_type_abbrevs.plist_factory</a></span>; origin_factory : <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Pvt_bin_prot_marshalling.ba_buf, Tjr_monad.With_lwt.lwt)</span> <a href="../../Tjr_plist/Plist_intf/index.html#type-origin_factory">Tjr_plist.Plist_intf.origin_factory</a></span>; &gt;</code></dt></dl></section></div></body></html>
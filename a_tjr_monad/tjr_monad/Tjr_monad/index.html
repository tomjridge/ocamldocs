<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tjr_monad (tjr_monad.Tjr_monad)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../index.html">tjr_monad</a> &#x00BB; Tjr_monad</nav><h1>Module <code>Tjr_monad</code></h1><p>Generic monads</p><nav class="toc"><ul><li><a href="#summary-of-main-types">Summary of main types</a></li><li><a href="#monad-types">Monad types</a></li><li><a href="#state-passing-monad">State passing monad</a></li><li><a href="#imperative-monad">Imperative monad</a></li><li><a href="#lwt-monad">Lwt monad</a></li><li><a href="#util">Util</a></li></ul></nav></header><section><header><h3 id="summary-of-main-types"><a href="#summary-of-main-types" class="anchor"></a>Summary of main types</h3></header><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include</span> <a href="../Tjr_monad__/index.html#module-Summary">Tjr_monad__.Summary</a></code></span></summary><aside><pre><code class="ml">type 't event_ops = {
  ev_create: 'a. unit -&gt; ('a event,'t) m;
  ev_wait: 'a. 'a event -&gt; ('a,'t) m;
  ev_signal: 'a. 'a event -&gt; 'a -&gt; (unit,'t)m;
}

type 't monad_ops = {
  return : 'a. 'a -&gt; ('a,'t) m;
  bind   : 'a 'b. ('a,'t) m -&gt; ('a -&gt; ('b,'t) m) -&gt; ('b,'t) m;
}

type ('mutex,'cvar,'t) mutex_ops = {
  create_mutex : unit -&gt; ('mutex,'t)m;
  create_cvar  : unit -&gt; ('cvar,'t)m;
  lock         : 'mutex -&gt; (unit,'t)m;
  signal       : 'cvar -&gt; (unit,'t)m;  (* FIXME broadcast? *)
  unlock       : 'mutex -&gt; (unit,'t)m;
  wait         : 'mutex -&gt; 'cvar -&gt; (unit,'t)m;
}

type ('s,'t) with_state = {
  with_state: 
    'a. 
      (* a function which has access to the state *)
      (state:'s -&gt; 
       set_state:('s -&gt; (unit,'t)m) -&gt; 
       (* and returns a value of type 'a in the monad *)
       ('a,'t) m)
    -&gt; ('a,'t)m
}</code></pre></aside></details></div></div></div></section><section><header><h3 id="monad-types"><a href="#monad-types" class="anchor"></a>Monad types</h3></header><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include</span> <a href="../Tjr_monad__/index.html#module-Monad_intf">Tjr_monad__.Monad_intf</a></code></span></summary><aside><p>Generic monad types. NOTE included in top-level package module</p></aside><section><header><h3 id="monad-ops"><a href="#monad-ops" class="anchor"></a>Monad ops</h3></header><dl><dt class="spec type" id="type-m"><a href="#type-m" class="anchor"></a><code><span class="keyword">type</span> <span>('a, 't) m</span></code></dt><dt class="spec type" id="type-monad_ops"><a href="#type-monad_ops" class="anchor"></a><code><span class="keyword">type</span> <span>'t monad_ops</span></code><code> = </code><code>{</code><table class="record"><tr id="type-monad_ops.return" class="anchored"><td class="def field"><a href="#type-monad_ops.return" class="anchor"></a><code>return : a. <span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>;</code></td></tr><tr id="type-monad_ops.bind" class="anchored"><td class="def field"><a href="#type-monad_ops.bind" class="anchor"></a><code>bind : a b. <span><span>(<span class="type-var">'a</span>, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span> <span>&#45;&gt;</span> <span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'b</span>, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>)</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'b</span>, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>;</code></td></tr></table><code>}</code></dt><dt class="spec type" id="type-async"><a href="#type-async" class="anchor"></a><code><span class="keyword">type</span> <span>'t async</span></code><code> = <span>(unit <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>)</span> <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span></code></dt><dd><p>The async operation completes with unit almost immediately; the argument may be a long-running computation; it is scheduled for execution.</p><p>NOTE Because even creating an 'a m in lwt schedules computation, we shield the argument to async to avoid computation.</p></dd></dl><dl><dt class="spec type" id="type-with_state"><a href="#type-with_state" class="anchor"></a><code><span class="keyword">type</span> <span>('s, 't) with_state</span></code><code> = </code><code>{</code><table class="record"><tr id="type-with_state.with_state" class="anchored"><td class="def field"><a href="#type-with_state.with_state" class="anchor"></a><code>with_state : a. <span>(<span>state:<span class="type-var">'s</span></span> <span>&#45;&gt;</span> <span>set_state:<span>(<span class="type-var">'s</span> <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>)</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>)</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>;</code></td></tr></table><code>}</code></dt><dd><p>A type to allow parameterization over a generic notion of &quot;part of state&quot;. Presumably the part of the state is locked while the monadic operation completes, and then the lock is released.</p><p>NOTE see also with_imperative_ref in Tjr_monad</p></dd></dl></section><section><header><h3 id="events,-with-signal"><a href="#events,-with-signal" class="anchor"></a>Events, with signal</h3></header><dl><dt class="spec type" id="type-event"><a href="#type-event" class="anchor"></a><code><span class="keyword">type</span> <span>'a event</span></code></dt><dd><p>The type of events that resolve to <code>'a</code></p></dd></dl><dl><dt class="spec type" id="type-event_ops"><a href="#type-event_ops" class="anchor"></a><code><span class="keyword">type</span> <span>'t event_ops</span></code><code> = </code><code>{</code><table class="record"><tr id="type-event_ops.ev_create" class="anchored"><td class="def field"><a href="#type-event_ops.ev_create" class="anchor"></a><code>ev_create : a. unit <span>&#45;&gt;</span> <span><span>(<span><span class="type-var">'a</span> <a href="index.html#type-event">event</a></span>, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>;</code></td></tr><tr id="type-event_ops.ev_wait" class="anchored"><td class="def field"><a href="#type-event_ops.ev_wait" class="anchor"></a><code>ev_wait : a. <span><span class="type-var">'a</span> <a href="index.html#type-event">event</a></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>;</code></td></tr><tr id="type-event_ops.ev_signal" class="anchored"><td class="def field"><a href="#type-event_ops.ev_signal" class="anchor"></a><code>ev_signal : a. <span><span class="type-var">'a</span> <a href="index.html#type-event">event</a></span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>;</code></td></tr></table><code>}</code></dt><dd><p>Multiple threads can be waiting on an event. Only one thread should signal the event. It is an error to signal the same event more than once. If this happens, the new signalled value is discarded and no further actions are taken. FIXME perhaps we should throw an exception or something. An event is a bit like a channel that multiple readers can register on (and all will receive any msgs), and which only carries at most one msg.</p><p>NOTE lwt has two types, <code>'a t</code> for promises and <code>'a u</code> for resolvers. These are implemented using the same underlying structure.</p></dd></dl></section><section><header><h3 id="mutexes-and-condition-variables"><a href="#mutexes-and-condition-variables" class="anchor"></a>Mutexes and condition variables</h3></header><dl><dt class="spec type" id="type-mutex_ops"><a href="#type-mutex_ops" class="anchor"></a><code><span class="keyword">type</span> <span>('mutex, 'cvar, 't) mutex_ops</span></code><code> = </code><code>{</code><table class="record"><tr id="type-mutex_ops.create_mutex" class="anchored"><td class="def field"><a href="#type-mutex_ops.create_mutex" class="anchor"></a><code>create_mutex : unit <span>&#45;&gt;</span> <span><span>(<span class="type-var">'mutex</span>, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>;</code></td></tr><tr id="type-mutex_ops.create_cvar" class="anchored"><td class="def field"><a href="#type-mutex_ops.create_cvar" class="anchor"></a><code>create_cvar : unit <span>&#45;&gt;</span> <span><span>(<span class="type-var">'cvar</span>, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>;</code></td></tr><tr id="type-mutex_ops.lock" class="anchored"><td class="def field"><a href="#type-mutex_ops.lock" class="anchor"></a><code>lock : <span class="type-var">'mutex</span> <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>;</code></td></tr><tr id="type-mutex_ops.signal" class="anchored"><td class="def field"><a href="#type-mutex_ops.signal" class="anchor"></a><code>signal : <span class="type-var">'cvar</span> <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>;</code></td></tr><tr id="type-mutex_ops.unlock" class="anchored"><td class="def field"><a href="#type-mutex_ops.unlock" class="anchor"></a><code>unlock : <span class="type-var">'mutex</span> <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>;</code></td></tr><tr id="type-mutex_ops.wait" class="anchored"><td class="def field"><a href="#type-mutex_ops.wait" class="anchor"></a><code>wait : <span class="type-var">'mutex</span> <span>&#45;&gt;</span> <span class="type-var">'cvar</span> <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> <a href="index.html#type-m">m</a></span>;</code></td></tr></table><code>}</code></dt><dd><p>What we need from mutexes and condition vars</p></dd></dl></section></details></div></div></div></section><section><header><h3 id="state-passing-monad"><a href="#state-passing-monad" class="anchor"></a>State passing monad</h3></header><dl><dt class="spec type" id="type-state_passing"><a href="#type-state_passing" class="anchor"></a><code><span class="keyword">type</span> <span>'a state_passing</span></code><code> = <span><span class="type-var">'a</span> <a href="State_passing/index.html#type-state_passing">State_passing.state_passing</a></span></code></dt></dl><aside><p>Conversions to and from function types</p></aside><dl><dt class="spec value" id="val-sp_to_fun"><a href="#val-sp_to_fun" class="anchor"></a><code><span class="keyword">val</span> sp_to_fun : <span><span>(<span class="type-var">'a</span>, <span><span class="type-var">'b</span> <a href="State_passing/index.html#type-state_passing">State_passing.state_passing</a></span>)</span> <a href="../Tjr_monad__/Monad_intf/index.html#type-m">Tjr_monad__.Monad_intf.m</a></span> <span>&#45;&gt;</span> <span class="type-var">'b</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> * <span class="type-var">'b</span></code></dt><dt class="spec value" id="val-sp_of_fun"><a href="#val-sp_of_fun" class="anchor"></a><code><span class="keyword">val</span> sp_of_fun : <span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <span class="type-var">'b</span> * <span class="type-var">'a</span>)</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'b</span>, <span><span class="type-var">'a</span> <a href="State_passing/index.html#type-state_passing">State_passing.state_passing</a></span>)</span> <a href="../Tjr_monad__/Monad_intf/index.html#type-m">Tjr_monad__.Monad_intf.m</a></span></code></dt></dl><dl><dt class="spec module" id="module-State_passing"><a href="#module-State_passing" class="anchor"></a><code><span class="keyword">module</span> <a href="State_passing/index.html">State_passing</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>A generic state-passing monad.</p></dd></dl><dl><dt class="spec value" id="val-state_passing_monad_ops"><a href="#val-state_passing_monad_ops" class="anchor"></a><code><span class="keyword">val</span> state_passing_monad_ops : unit <span>&#45;&gt;</span> <span><span><span class="type-var">'a</span> <a href="State_passing/index.html#type-state_passing">State_passing.state_passing</a></span> <a href="../Tjr_monad__/Monad_intf/index.html#type-monad_ops">Tjr_monad__.Monad_intf.monad_ops</a></span></code></dt></dl></section><section><header><h3 id="imperative-monad"><a href="#imperative-monad" class="anchor"></a>Imperative monad</h3></header><dl><dt class="spec module" id="module-Imperative"><a href="#module-Imperative" class="anchor"></a><code><span class="keyword">module</span> <a href="Imperative/index.html">Imperative</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>A trivial monad, where bind is just function composition, and return is the identity. Used when performing imperative operations eg Unix.read/write. AKA the identity monad</p></dd></dl><dl><dt class="spec type" id="type-imperative"><a href="#type-imperative" class="anchor"></a><code><span class="keyword">type</span> imperative</code><code> = <a href="Imperative/index.html#type-imperative">Imperative.imperative</a></code></dt></dl><dl><dt class="spec value" id="val-imperative_monad_ops"><a href="#val-imperative_monad_ops" class="anchor"></a><code><span class="keyword">val</span> imperative_monad_ops : <span><a href="Imperative/index.html#type-imperative">Imperative.imperative</a> <a href="../Tjr_monad__/Monad_intf/index.html#type-monad_ops">Tjr_monad__.Monad_intf.monad_ops</a></span></code></dt></dl></section><section><header><h3 id="lwt-monad"><a href="#lwt-monad" class="anchor"></a>Lwt monad</h3></header><div class="spec module" id="module-With_lwt"><a href="#module-With_lwt" class="anchor"></a><code><span class="keyword">module</span> <a href="With_lwt/index.html">With_lwt</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec type" id="type-lwt"><a href="#type-lwt" class="anchor"></a><code><span class="keyword">type</span> lwt</code><code> = <a href="With_lwt/index.html#type-lwt">With_lwt.lwt</a></code></dt></dl><dl><dt class="spec value" id="val-lwt_monad_ops"><a href="#val-lwt_monad_ops" class="anchor"></a><code><span class="keyword">val</span> lwt_monad_ops : <span><a href="With_lwt/index.html#type-lwt">With_lwt.lwt</a> <a href="../Tjr_monad__/Monad_intf/index.html#type-monad_ops">Tjr_monad__.Monad_intf.monad_ops</a></span></code></dt><dt class="spec value" id="val-lwt_event_ops"><a href="#val-lwt_event_ops" class="anchor"></a><code><span class="keyword">val</span> lwt_event_ops : <span><a href="With_lwt/index.html#type-lwt">With_lwt.lwt</a> <a href="../Tjr_monad__/Monad_intf/index.html#type-event_ops">Tjr_monad__.Monad_intf.event_ops</a></span></code></dt><dt class="spec value" id="val-lwt_mutex_ops"><a href="#val-lwt_mutex_ops" class="anchor"></a><code><span class="keyword">val</span> lwt_mutex_ops : <span><span>(Lwt_mutex.t, <span>unit Lwt_condition.t</span>, <a href="With_lwt/index.html#type-lwt">With_lwt.lwt</a>)</span> <a href="../Tjr_monad__/Monad_intf/index.html#type-mutex_ops">Tjr_monad__.Monad_intf.mutex_ops</a></span></code></dt><dt class="spec value" id="val-lwt_file_ops"><a href="#val-lwt_file_ops" class="anchor"></a><code><span class="keyword">val</span> lwt_file_ops : &lt; close : Lwt_unix.file_descr <span>&#45;&gt;</span> <span><span>(unit, <a href="With_lwt/index.html#type-lwt">With_lwt.lwt</a>)</span> <a href="../Tjr_monad__/Monad_intf/index.html#type-m">Tjr_monad__.Monad_intf.m</a></span>; open_file : <span>fn:string</span> <span>&#45;&gt;</span> <span>create:bool</span> <span>&#45;&gt;</span> <span>trunc:bool</span> <span>&#45;&gt;</span> <span><span>(Lwt_unix.file_descr, <a href="With_lwt/index.html#type-lwt">With_lwt.lwt</a>)</span> <a href="../Tjr_monad__/Monad_intf/index.html#type-m">Tjr_monad__.Monad_intf.m</a></span>; pread : <span>fd:Lwt_unix.file_descr</span> <span>&#45;&gt;</span> <span>off:int</span> <span>&#45;&gt;</span> <span>len:int</span> <span>&#45;&gt;</span> <span><span>(bytes, <a href="With_lwt/index.html#type-lwt">With_lwt.lwt</a>)</span> <a href="../Tjr_monad__/Monad_intf/index.html#type-m">Tjr_monad__.Monad_intf.m</a></span>; pwrite : <span>fd:Lwt_unix.file_descr</span> <span>&#45;&gt;</span> <span>off:int</span> <span>&#45;&gt;</span> <span>buf:bytes</span> <span>&#45;&gt;</span> <span><span>(unit, <a href="With_lwt/index.html#type-lwt">With_lwt.lwt</a>)</span> <a href="../Tjr_monad__/Monad_intf/index.html#type-m">Tjr_monad__.Monad_intf.m</a></span>; sync : Lwt_unix.file_descr <span>&#45;&gt;</span> <span><span>(unit, <a href="With_lwt/index.html#type-lwt">With_lwt.lwt</a>)</span> <a href="../Tjr_monad__/Monad_intf/index.html#type-m">Tjr_monad__.Monad_intf.m</a></span>; &gt;</code></dt></dl></section><section><header><h3 id="util"><a href="#util" class="anchor"></a>Util</h3></header><dl><dt class="spec value" id="val-with_imperative_ref"><a href="#val-with_imperative_ref" class="anchor"></a><code><span class="keyword">val</span> with_imperative_ref : <span>monad_ops:<span><span class="type-var">'a</span> <a href="index.html#type-monad_ops">monad_ops</a></span></span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> Stdlib.ref</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'b</span>, <span class="type-var">'a</span>)</span> <a href="index.html#type-with_state">with_state</a></span></code></dt><dd><p>WARNING this is not locked</p></dd></dl></section></div></body></html>
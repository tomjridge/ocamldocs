<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Lru_two_gen_v3pure (tjr_lib_core.Tjr_lib_core.Lru_two_gen_v3pure)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">tjr_lib_core</a> &#x00BB; <a href="../index.html">Tjr_lib_core</a> &#x00BB; Lru_two_gen_v3pure</nav><h1>Module <code>Tjr_lib_core.Lru_two_gen_v3pure</code></h1><p>Internal module</p><nav class="toc"><ul><li><a href="#version-with-delete">Version with delete</a></li></ul></nav></header><aside></aside><aside><p>A two-generation LRU with batch eviction. Compared to v3, this is the pure part only (no monad or handling of slow operations).</p><p>This tries to take advantage of the extremely good performance of hashtables.</p><p>We assume a limit N on the number of most-recent items we want to track.</p><p>The idea is to maintain two maps (hence &quot;two generations&quot;). The first is of size n1 &lt;=N, and contains the n1 most recently used elements. The second is typically of size N, and the next (N-n1) most-recent elements are contained in this set. In the case where the set is of size n2 &lt; N, then only the most recent n1+n2 items are tracked (FIXME?)</p><p>When the first map reaches the limit N, it is demoted to the second map, and the second map is dropped. At this point, we need to expunge multiple elements from the cache, so this is &quot;batch eviction&quot;.</p><p>Looking up an item consults the first map first, then the second, then the underlying map.</p><p>Compared to standard LRU, the implementation is likely simpler and faster. Of course, you don't have full information about the ordering of the most-recently used items. But in the case where you are maintaining a cache, this doesn't matter so much.</p><p>NOTE a quick google search finds that this may be similar: https://github.com/dominictarr/hashlru , with some benchmarking here: https://github.com/dominictarr/bench-lru</p><p>Don't open - record field clashes, type clashes</p></aside><section><header><h3 id="version-with-delete"><a href="#version-with-delete" class="anchor"></a>Version with delete</h3></header><dl><dt class="spec type" id="type-entry"><a href="#type-entry" class="anchor"></a><code><span class="keyword">type</span> <span>'v entry</span></code> = <code>[ </code><table class="variant"><tr id="type-entry.Inserted" class="anchored"><td class="def constructor"><a href="#type-entry.Inserted" class="anchor"></a><code>| </code><code>`Inserted <span class="keyword">of</span> <span class="type-var">'v</span></code></td></tr><tr id="type-entry.Deleted" class="anchored"><td class="def constructor"><a href="#type-entry.Deleted" class="anchor"></a><code>| </code><code>`Deleted</code></td></tr><tr id="type-entry.Lower_some" class="anchored"><td class="def constructor"><a href="#type-entry.Lower_some" class="anchor"></a><code>| </code><code>`Lower_some <span class="keyword">of</span> <span class="type-var">'v</span></code></td></tr><tr id="type-entry.Lower_none" class="anchored"><td class="def constructor"><a href="#type-entry.Lower_none" class="anchor"></a><code>| </code><code>`Lower_none</code></td></tr></table><code> ]</code></dt><dd><p>Entries in the internal maps can record that an entry has been deleted, or that an entry is present in the lower map m3;</p><pre><code class="ml">type 'v entry = [ `Inserted of 'v | `Deleted | `Lower_some of 'v | `Lower_none ] </code></pre></dd></dl><dl><dt class="spec type" id="type-dirty_entry"><a href="#type-dirty_entry" class="anchor"></a><code><span class="keyword">type</span> <span>'v dirty_entry</span></code> = <code>[ </code><table class="variant"><tr id="type-dirty_entry.Inserted" class="anchored"><td class="def constructor"><a href="#type-dirty_entry.Inserted" class="anchor"></a><code>| </code><code>`Inserted <span class="keyword">of</span> <span class="type-var">'v</span></code></td></tr><tr id="type-dirty_entry.Deleted" class="anchored"><td class="def constructor"><a href="#type-dirty_entry.Deleted" class="anchor"></a><code>| </code><code>`Deleted</code></td></tr></table><code> ]</code></dt></dl><dl><dt class="spec module" id="module-Cache_state"><a href="#module-Cache_state" class="anchor"></a><code><span class="keyword">module</span> <a href="Cache_state/index.html">Cache_state</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Cache state; internal</p></dd></dl><dl><dt class="spec type" id="type-ops"><a href="#type-ops" class="anchor"></a><code><span class="keyword">type</span> <span>('k, 'v, 'c) ops</span></code><code> = </code><code>{</code><table class="record"><tr id="type-ops.find_raw" class="anchored"><td class="def field"><a href="#type-ops.find_raw" class="anchor"></a><code>find_raw : <span>c:<span class="type-var">'c</span></span> <span>&#45;&gt;</span> <span class="type-var">'k</span> <span>&#45;&gt;</span> <span><span><span class="type-var">'v</span> <a href="index.html#type-entry">entry</a></span> option</span>;</code></td></tr><tr id="type-ops.insert" class="anchored"><td class="def field"><a href="#type-ops.insert" class="anchor"></a><code>insert : <span>c:<span class="type-var">'c</span></span> <span>&#45;&gt;</span> <span class="type-var">'k</span> <span>&#45;&gt;</span> <span class="type-var">'v</span> <span>&#45;&gt;</span> unit;</code></td></tr><tr id="type-ops.insert_raw" class="anchored"><td class="def field"><a href="#type-ops.insert_raw" class="anchor"></a><code>insert_raw : <span>c:<span class="type-var">'c</span></span> <span>&#45;&gt;</span> <span class="type-var">'k</span> <span>&#45;&gt;</span> <span><span class="type-var">'v</span> <a href="index.html#type-entry">entry</a></span> <span>&#45;&gt;</span> unit;</code></td></tr><tr id="type-ops.delete" class="anchored"><td class="def field"><a href="#type-ops.delete" class="anchor"></a><code>delete : <span>c:<span class="type-var">'c</span></span> <span>&#45;&gt;</span> <span class="type-var">'k</span> <span>&#45;&gt;</span> unit;</code></td></tr><tr id="type-ops.needs_trim" class="anchored"><td class="def field"><a href="#type-ops.needs_trim" class="anchor"></a><code>needs_trim : <span>c:<span class="type-var">'c</span></span> <span>&#45;&gt;</span> bool;</code></td></tr><tr id="type-ops.trim" class="anchored"><td class="def field"><a href="#type-ops.trim" class="anchor"></a><code>trim : <span>c:<span class="type-var">'c</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'k</span> * <span><span class="type-var">'v</span> <a href="index.html#type-entry">entry</a></span>)</span> list</span>;</code></td></tr><tr id="type-ops.bindings" class="anchored"><td class="def field"><a href="#type-ops.bindings" class="anchor"></a><code>bindings : <span>c:<span class="type-var">'c</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'k</span> * <span><span class="type-var">'v</span> <a href="index.html#type-entry">entry</a></span>)</span> list</span>;</code></td></tr><tr id="type-ops.dirties" class="anchored"><td class="def field"><a href="#type-ops.dirties" class="anchor"></a><code>dirties : <span>c:<span class="type-var">'c</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'k</span> * <span><span class="type-var">'v</span> <a href="index.html#type-dirty_entry">dirty_entry</a></span>)</span> list</span>;</code></td></tr><tr id="type-ops.clean" class="anchored"><td class="def field"><a href="#type-ops.clean" class="anchor"></a><code>clean : <span>c:<span class="type-var">'c</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'k</span> * <span><span class="type-var">'v</span> <a href="index.html#type-dirty_entry">dirty_entry</a></span>)</span> list</span>;</code></td></tr><tr id="type-ops.debug" class="anchored"><td class="def field"><a href="#type-ops.debug" class="anchor"></a><code>debug : <span>c:<span class="type-var">'c</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'k</span>, <span><span class="type-var">'v</span> <a href="index.html#type-entry">entry</a></span>)</span> <a href="../../Tjr_lib_core__/index.html#module-Hashtbl">Tjr_lib_core__.Hashtbl</a>.t</span> * <span><span>(<span class="type-var">'k</span>, <span><span class="type-var">'v</span> <a href="index.html#type-entry">entry</a></span>)</span> <a href="../../Tjr_lib_core__/index.html#module-Hashtbl">Tjr_lib_core__.Hashtbl</a>.t</span>;</code></td></tr></table><code>}</code></dt><dd><p>API; 'c is the cache type</p></dd></dl><div class="spec module-type" id="module-type-S"><a href="#module-type-S" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-S/index.html">S</a> = <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module-type" id="module-type-T"><a href="#module-type-T" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-T/index.html">T</a> = <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec module" id="module-Make"><a href="#module-Make" class="anchor"></a><code><span class="keyword">module</span> <a href="Make/index.html">Make</a> : <span class="keyword">functor</span> (<a href="Make/argument-1-S/index.html">S</a> : <a href="index.html#module-type-S">S</a>) <span>&#45;&gt;</span> <a href="index.html#module-type-T">T</a> <span class="keyword">with</span> <span class="keyword">module</span> <a href="Make/S/index.html">S</a> = <a href="Make/index.html#argument-1-S">S</a></code></dt><dd><p>For some applications, we want very precise control of the cache, ie not to have the cache state hidden inside functions, but instead be referenced explicitly</p></dd></dl></section></div></body></html>
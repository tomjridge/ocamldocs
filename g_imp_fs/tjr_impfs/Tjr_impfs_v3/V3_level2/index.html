<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>V3_level2 (tjr_impfs.Tjr_impfs_v3.V3_level2)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tjr_impfs</a> &#x00BB; <a href="../index.html">Tjr_impfs_v3</a> &#x00BB; V3_level2</nav><header class="odoc-preamble"><h1>Module <code><span>Tjr_impfs_v3.V3_level2</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#preamble">Preamble</a></li><li><a href="#directories">Directories</a></li></ul></nav><div class="odoc-content"><p>V3 level 2 is the lowest implementation level; SQLite is used to implement directories and metadata (?) and some other filesystem is used to implement files.</p><p>This version focuses on the front end caching and locking, so we delegate dirs and files to SQLite/the existing filesystem.</p><p>We maintain a cache of live files, live dirs.</p><p>We use kref reference counting to ensure that objects are not removed from the cache whilst we operate on them. Locked objects can never be removed from the cache, but we maintain an invariant that any locked object must have an existing kref, so it should never be the case that there are no references but an object is locked.</p><p>In order to operate on an object, we first obtain a kref: <code>krefs.get id</code>. This ensures that the object is in the cache and will not be flushed.</p><h3 id="preamble"><a href="#preamble" class="anchor"></a>Preamble</h3><div class="odoc-spec"><div class="spec value" id="val-line" class="anchored"><a href="#val-line" class="anchor"></a><code><span><span class="keyword">val</span> line : <span>int <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-R" class="anchored"><a href="#module-R" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="R/index.html">R</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-S0" class="anchored"><a href="#module-S0" class="anchor"></a><code><span><span class="keyword">module</span> </span><span>S0</span><span> = <a href="../V3_base_types/index.html">V3_base_types</a></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-S1" class="anchored"><a href="#module-S1" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="S1/index.html">S1</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Level2_provides" class="anchored"><a href="#module-Level2_provides" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Level2_provides/index.html">Level2_provides</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-T2" class="anchored"><a href="#module-type-T2" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> </span><span>T2</span><span> = <a href="Level2_provides/module-type-T2/index.html">Level2_provides.T2</a></span></code></div><div class="spec-doc"><p>What we have to implement - see <a href="Stage2/index.html"><code>Stage2</code></a> below.</p></div></div><h3 id="directories"><a href="#directories" class="anchor"></a>Directories</h3><div class="odoc-spec"><div class="spec type" id="type-config" class="anchored"><a href="#type-config" class="anchor"></a><code><span><span class="keyword">type</span> config</span><span> = </span><span>{</span></code><table><tr id="type-config.entries_cache_capacity" class="anchored"><td class="def record field"><a href="#type-config.entries_cache_capacity" class="anchor"></a><code><span>entries_cache_capacity : int;</span></code></td></tr><tr id="type-config.entries_cache_trim_delta" class="anchored"><td class="def record field"><a href="#type-config.entries_cache_trim_delta" class="anchor"></a><code><span>entries_cache_trim_delta : int;</span></code></td></tr><tr id="type-config.live_dirs_capacity" class="anchored"><td class="def record field"><a href="#type-config.live_dirs_capacity" class="anchor"></a><code><span>live_dirs_capacity : int;</span></code></td></tr><tr id="type-config.live_dirs_trim_delta" class="anchored"><td class="def record field"><a href="#type-config.live_dirs_trim_delta" class="anchor"></a><code><span>live_dirs_trim_delta : int;</span></code></td></tr><tr id="type-config.file_data_path" class="anchored"><td class="def record field"><a href="#type-config.file_data_path" class="anchor"></a><code><span>file_data_path : string;</span></code></td></tr><tr id="type-config.live_files_capacity" class="anchored"><td class="def record field"><a href="#type-config.live_files_capacity" class="anchor"></a><code><span>live_files_capacity : int;</span></code></td></tr><tr id="type-config.live_files_trim_delta" class="anchored"><td class="def record field"><a href="#type-config.live_files_trim_delta" class="anchor"></a><code><span>live_files_trim_delta : int;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>Configuration params known at module init time</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Directories_prelude" class="anchored"><a href="#module-Directories_prelude" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Directories_prelude/index.html">Directories_prelude</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>NOTE nothing in here is actually exposed in <a href="Stage2/index.html"><code>Stage2</code></a> below; could just open the structure rather than binding it</p></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-STAGE1" class="anchored"><a href="#module-type-STAGE1" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> </span><span><a href="module-type-STAGE1/index.html">STAGE1</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Stage 1 is immediately after connection to the SQLite backend; it includes the <code>sql_dir_ops</code> live connection to the database</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Stage2" class="anchored"><a href="#module-Stage2" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Stage2/index.html">Stage2</a></span><span> (<a href="Stage2/argument-1-Stage1/index.html">Stage1</a> : <a href="module-type-STAGE1/index.html">STAGE1</a>) : <a href="Level2_provides/module-type-T2/index.html">T2</a></span></code></div><div class="spec-doc"><p>Stage 2 uses the connection to SQLite to build the rest of the <a href="Level2_provides/module-type-T2/index.html"><code>T2</code></a> interface</p></div></div></div></body></html>
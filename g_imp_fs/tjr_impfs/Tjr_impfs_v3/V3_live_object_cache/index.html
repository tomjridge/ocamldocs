<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>V3_live_object_cache (tjr_impfs.Tjr_impfs_v3.V3_live_object_cache)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">tjr_impfs</a> &#x00BB; <a href="../index.html">Tjr_impfs_v3</a> &#x00BB; V3_live_object_cache</nav><header class="odoc-preamble"><h1>Module <code><span>Tjr_impfs_v3.V3_live_object_cache</span></code></h1></header><div class="odoc-content"><p>Live object cache.</p><p>A cache of &quot;live&quot; objects. Expunging an object may take some time. Resurrecting an object may take some time. We use reference counting to prevent objects from being expunged while references remain live.</p><p>We are maintaining a cache of objects by id. We can maintain the counter with the object. A kref is an abstract wrapper round the object. Essentially it provides: kref_to_obj: kref -&gt; obj. It also includes put: kref -&gt; unit which destroys the kref and reduces the underlying count.</p><p>Don't open.</p><div class="odoc-spec"><div class="spec value" id="val-line" class="anchored"><a href="#val-line" class="anchor"></a><code><span><span class="keyword">val</span> line : <span>int <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-kref_ops" class="anchored"><a href="#type-kref_ops" class="anchor"></a><code><span><span class="keyword">type</span> <span>('obj, 'kref) kref_ops</span></span><span> = </span><span>{</span></code><table><tr id="type-kref_ops.kref_to_obj" class="anchored"><td class="def record field"><a href="#type-kref_ops.kref_to_obj" class="anchor"></a><code><span>kref_to_obj : <span><span class="type-var">'kref</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'obj</span>;</span></code></td></tr><tr id="type-kref_ops.krelease" class="anchored"><td class="def record field"><a href="#type-kref_ops.krelease" class="anchor"></a><code><span>krelease : <span><span class="type-var">'kref</span> <span class="arrow">&#45;&gt;</span></span> unit;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>User view of krefs; the user must call krelease when finished with the object.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Private_kref_impl" class="anchored"><a href="#module-Private_kref_impl" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Private_kref_impl/index.html">Private_kref_impl</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-kref" class="anchored"><a href="#type-kref" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a kref</span></span><span> = <span><span class="type-var">'a</span> <a href="Private_kref_impl/index.html#type-kref">Private_kref_impl.kref</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-kref_ops" class="anchored"><a href="#val-kref_ops" class="anchor"></a><code><span><span class="keyword">val</span> kref_ops : <span><span>(<span class="type-var">'a</span>, <span><span class="type-var">'a</span> <a href="Private_kref_impl/index.html#type-kref">Private_kref_impl.kref</a></span>)</span> <a href="#type-kref_ops">kref_ops</a></span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Kref" class="anchored"><a href="#module-Kref" class="anchor"></a><code><span><span class="keyword">module</span> </span><span>Kref</span><span> = <a href="Private_kref_impl/index.html">Private_kref_impl</a></span></code></div></div><p>A cache of live objects is just an LRU of ref counted objects</p><div class="odoc-spec"><div class="spec type" id="type-counted" class="anchored"><a href="#type-counted" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a counted</span></span><span> = </span><span>{</span></code><table><tr id="type-counted.count" class="anchored"><td class="def record field"><a href="#type-counted.count" class="anchor"></a><code><span>count : <span>int <span class="xref-unresolved">Stdlib</span>.ref</span>;</span></code></td></tr><tr id="type-counted.obj" class="anchored"><td class="def record field"><a href="#type-counted.obj" class="anchor"></a><code><span>obj : <span class="type-var">'a</span>;</span></code></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-entry" class="anchored"><a href="#type-entry" class="anchor"></a><code><span><span class="keyword">type</span> <span>('a, 't) entry</span></span><span> = </span><span>[ </span></code><table><tr id="type-entry.Resurrecting" class="anchored"><td class="def constructor"><a href="#type-entry.Resurrecting" class="anchor"></a><code><span>| </span></code><code><span>`Resurrecting <span class="keyword">of</span> <span><span>(unit, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span></span></code></td></tr><tr id="type-entry.Present" class="anchored"><td class="def constructor"><a href="#type-entry.Present" class="anchor"></a><code><span>| </span></code><code><span>`Present <span class="keyword">of</span> <span><span class="type-var">'a</span> <a href="#type-counted">counted</a></span></span></code></td></tr><tr id="type-entry.Finalising" class="anchored"><td class="def constructor"><a href="#type-entry.Finalising" class="anchor"></a><code><span>| </span></code><code><span>`Finalising <span class="keyword">of</span> <span><span>(unit, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span></span></code></td></tr></table><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-config" class="anchored"><a href="#type-config" class="anchor"></a><code><span><span class="keyword">type</span> config</span><span> = </span><span>{</span></code><table><tr id="type-config.cache_size" class="anchored"><td class="def record field"><a href="#type-config.cache_size" class="anchor"></a><code><span>cache_size : int;</span></code></td></tr><tr id="type-config.trim_delta" class="anchored"><td class="def record field"><a href="#type-config.trim_delta" class="anchor"></a><code><span>trim_delta : int;</span></code></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-cache" class="anchored"><a href="#type-cache" class="anchor"></a><code><span><span class="keyword">type</span> <span>('lru, 't) cache</span></span><span> = </span><span>{</span></code><table><tr id="type-cache.lru" class="anchored"><td class="def record field"><a href="#type-cache.lru" class="anchor"></a><code><span>lru : <span class="type-var">'lru</span>;</span></code></td></tr><tr id="type-cache.config" class="anchored"><td class="def record field"><a href="#type-cache.config" class="anchor"></a><code><span>config : <a href="#type-config">config</a>;</span></code></td></tr><tr id="type-cache.gc_thread" class="anchored"><td class="def record field"><a href="#type-cache.gc_thread" class="anchor"></a><code><span><span class="keyword">mutable</span> gc_thread : <span><span>(unit, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>;</span></code></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-cache_ops" class="anchored"><a href="#type-cache_ops" class="anchor"></a><code><span><span class="keyword">type</span> <span>('id, 'a, 'kref, 'cache, 't) cache_ops</span></span><span> = </span><span>{</span></code><table><tr id="type-cache_ops.create" class="anchored"><td class="def record field"><a href="#type-cache_ops.create" class="anchor"></a><code><span>create : <span>config:<a href="#type-config">config</a> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'cache</span>;</span></code></td></tr><tr id="type-cache_ops.get" class="anchored"><td class="def record field"><a href="#type-cache_ops.get" class="anchor"></a><code><span>get : <span><span class="type-var">'id</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'cache</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'kref</span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>;</span></code></td></tr><tr id="type-cache_ops.put" class="anchored"><td class="def record field"><a href="#type-cache_ops.put" class="anchor"></a><code><span>put : <span><span class="type-var">'kref</span> <span class="arrow">&#45;&gt;</span></span> unit;</span></code></td></tr><tr id="type-cache_ops.kref_to_obj" class="anchored"><td class="def record field"><a href="#type-cache_ops.kref_to_obj" class="anchor"></a><code><span>kref_to_obj : <span><span class="type-var">'kref</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>;</span></code></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-S" class="anchored"><a href="#module-type-S" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> </span><span><a href="module-type-S/index.html">S</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-T" class="anchored"><a href="#module-type-T" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> </span><span><a href="module-type-T/index.html">T</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Make" class="anchored"><a href="#module-Make" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Make/index.html">Make</a></span><span> (<a href="Make/argument-1-S/index.html">S</a> : <a href="module-type-S/index.html">S</a>) : <a href="module-type-T/index.html">T</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="module-type-T/index.html#type-id">id</a> = <a href="Make/argument-1-S/index.html#type-id">S.id</a></span> <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="module-type-T/index.html#type-a">a</a> = <a href="Make/argument-1-S/index.html#type-a">S.a</a></span></span></code></div></div></div></body></html>
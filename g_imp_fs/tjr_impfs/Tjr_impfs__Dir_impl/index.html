<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tjr_impfs__Dir_impl (tjr_impfs.Tjr_impfs__Dir_impl)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../index.html">tjr_impfs</a> &#x00BB; Tjr_impfs__Dir_impl</nav><h1>Module <code>Tjr_impfs__Dir_impl</code></h1><p>A simple directory implementation; NOTE this module safe to open.</p><p>Directories are one of the main objects we deal with.</p><p>We implement a directory as a map from name (string, max length 256 bytes) to entry (file, directory or symlink). Of course, this uses an underlying B-tree.</p><p>Any used blocks are recorded in a per-directory-object used list. Currently, blocks are only reclaimed when the directory is deleted. Later, we plan to implement cleaning of directories that are still live, to free up blocks that are no longer used.</p><p>We reuse the usedlist implementation from <code>File_impl_v2</code>.</p><p>A directory is really a thin layer over a B-tree, interfacing with the used list, and handling the origin block.</p></header><dl><dt class="spec type" id="type-stat_times"><a href="#type-stat_times" class="anchor"></a><code><span class="keyword">type</span> stat_times</code><code> = Tjr_minifs.Minifs_intf.times</code></dt></dl><div><div class="spec include"><div class="doc"><dl><dt class="spec value" id="val-bin_shape_stat_times"><a href="#val-bin_shape_stat_times" class="anchor"></a><code><span class="keyword">val</span> bin_shape_stat_times : Bin_prot.Shape.t</code></dt><dt class="spec value" id="val-bin_size_stat_times"><a href="#val-bin_size_stat_times" class="anchor"></a><code><span class="keyword">val</span> bin_size_stat_times : <span><a href="index.html#type-stat_times">stat_times</a> Bin_prot.Size.sizer</span></code></dt><dt class="spec value" id="val-bin_write_stat_times"><a href="#val-bin_write_stat_times" class="anchor"></a><code><span class="keyword">val</span> bin_write_stat_times : <span><a href="index.html#type-stat_times">stat_times</a> Bin_prot.Write.writer</span></code></dt><dt class="spec value" id="val-bin_writer_stat_times"><a href="#val-bin_writer_stat_times" class="anchor"></a><code><span class="keyword">val</span> bin_writer_stat_times : <span><a href="index.html#type-stat_times">stat_times</a> Bin_prot.Type_class.writer</span></code></dt><dt class="spec value" id="val-__bin_read_stat_times__"><a href="#val-__bin_read_stat_times__" class="anchor"></a><code><span class="keyword">val</span> __bin_read_stat_times__ : <span><span>(int <span>&#45;&gt;</span> <a href="index.html#type-stat_times">stat_times</a>)</span> Bin_prot.Read.reader</span></code></dt><dt class="spec value" id="val-bin_read_stat_times"><a href="#val-bin_read_stat_times" class="anchor"></a><code><span class="keyword">val</span> bin_read_stat_times : <span><a href="index.html#type-stat_times">stat_times</a> Bin_prot.Read.reader</span></code></dt><dt class="spec value" id="val-bin_reader_stat_times"><a href="#val-bin_reader_stat_times" class="anchor"></a><code><span class="keyword">val</span> bin_reader_stat_times : <span><a href="index.html#type-stat_times">stat_times</a> Bin_prot.Type_class.reader</span></code></dt><dt class="spec value" id="val-bin_stat_times"><a href="#val-bin_stat_times" class="anchor"></a><code><span class="keyword">val</span> bin_stat_times : <span><a href="index.html#type-stat_times">stat_times</a> Bin_prot.Type_class.t</span></code></dt></dl></div></div></div><div class="spec module" id="module-Dir_origin"><a href="#module-Dir_origin" class="anchor"></a><code><span class="keyword">module</span> <a href="Dir_origin/index.html">Dir_origin</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Dir_ops"><a href="#module-Dir_ops" class="anchor"></a><code><span class="keyword">module</span> <a href="Dir_ops/index.html">Dir_ops</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec module" id="module-Dir_im"><a href="#module-Dir_im" class="anchor"></a><code><span class="keyword">module</span> <a href="Dir_im/index.html">Dir_im</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>What we keep in memory to represent a dir (in addition to the used list and the dir map)</p></dd></dl><dl><dt class="spec type" id="type-dir_factory"><a href="#type-dir_factory" class="anchor"></a><code><span class="keyword">type</span> <span>('blk_id, 'blk, 'de, 't, 'did) dir_factory</span></code><code> = &lt; read_origin : <span>blk_dev_ops:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'blk</span>, <span class="type-var">'t</span>)</span> Tjr_fs_shared.blk_dev_ops</span></span> <span>&#45;&gt;</span> <span>blk_id:<span class="type-var">'blk_id</span></span> <span>&#45;&gt;</span> <span><span>(<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'did</span>)</span> <a href="Dir_origin/index.html#type-t">Dir_origin.t</a></span>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>; write_origin : <span>blk_dev_ops:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'blk</span>, <span class="type-var">'t</span>)</span> Tjr_fs_shared.blk_dev_ops</span></span> <span>&#45;&gt;</span> <span>blk_id:<span class="type-var">'blk_id</span></span> <span>&#45;&gt;</span> <span>origin:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'did</span>)</span> <a href="Dir_origin/index.html#type-t">Dir_origin.t</a></span></span> <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>; with_ : <span>blk_dev_ops:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'blk</span>, <span class="type-var">'t</span>)</span> Tjr_fs_shared.blk_dev_ops</span></span> <span>&#45;&gt;</span> <span>barrier:<span>(unit <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>)</span></span> <span>&#45;&gt;</span> <span>sync:<span>(unit <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>)</span></span> <span>&#45;&gt;</span> <span>freelist_ops:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> <a href="../Tjr_impfs/Freelist_intf/index.html#type-freelist_ops">Tjr_impfs.Freelist_intf.freelist_ops</a></span></span> <span>&#45;&gt;</span> &lt; usedlist_ops : <span><span class="type-var">'blk_id</span> <a href="../Tjr_impfs/Usedlist_impl/Usedlist/index.html#type-origin">Tjr_impfs.Usedlist_impl.Usedlist.origin</a></span> <span>&#45;&gt;</span> <span><span>(<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> <a href="../Tjr_impfs/Usedlist_impl/Usedlist/index.html#type-ops">Tjr_impfs.Usedlist_impl.Usedlist.ops</a></span>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>; alloc_via_usedlist : <span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> <a href="../Tjr_impfs/Usedlist_impl/Usedlist/index.html#type-ops">Tjr_impfs.Usedlist_impl.Usedlist.ops</a></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> Tjr_fs_shared.blk_allocator_ops</span>; mk_dir : <span>usedlist:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> <a href="../Tjr_impfs/Usedlist_impl/Usedlist/index.html#type-ops">Tjr_impfs.Usedlist_impl.Usedlist.ops</a></span></span> <span>&#45;&gt;</span> <span>btree_root:<span class="type-var">'blk_id</span></span> <span>&#45;&gt;</span> <span>with_dir:<span><span>(<span><span class="type-var">'did</span> <a href="Dir_im/index.html#type-dir_im">Dir_im.dir_im</a></span>, <span class="type-var">'t</span>)</span> Tjr_monad.with_state</span></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.str_256, <span class="type-var">'de</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="Dir_ops/index.html#type-t">Dir_ops.t</a></span>; create_root_dir : <span>root_did:<span class="type-var">'did</span></span> <span>&#45;&gt;</span> <span>times:<a href="index.html#type-stat_times">stat_times</a></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>; create_dir : <span>parent:<span class="type-var">'did</span></span> <span>&#45;&gt;</span> <span>times:<a href="index.html#type-stat_times">stat_times</a></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>; dir_add_autosync : <span class="type-var">'blk_id</span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.str_256, <span class="type-var">'de</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="Dir_ops/index.html#type-t">Dir_ops.t</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.str_256, <span class="type-var">'de</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="Dir_ops/index.html#type-t">Dir_ops.t</a></span>; dir_from_origin_blk : <span>(<span class="type-var">'blk_id</span> * <span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'did</span>)</span> <a href="Dir_origin/index.html#type-t">Dir_origin.t</a></span>)</span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.str_256, <span class="type-var">'de</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="Dir_ops/index.html#type-t">Dir_ops.t</a></span>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>; dir_from_origin : <span class="type-var">'blk_id</span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.str_256, <span class="type-var">'de</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="Dir_ops/index.html#type-t">Dir_ops.t</a></span>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>; &gt;; &gt;</code></dt><dd><p>NOTE 'de stands for dir_entry</p></dd></dl><div class="spec module-type" id="module-type-S"><a href="#module-type-S" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-S/index.html">S</a> = <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module-type" id="module-type-T"><a href="#module-type-T" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-T/index.html">T</a> = <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec module" id="module-Make_v1"><a href="#module-Make_v1" class="anchor"></a><code><span class="keyword">module</span> <a href="Make_v1/index.html">Make_v1</a> : <span class="keyword">functor</span> (<a href="Make_v1/argument-1-S/index.html">S</a> : <a href="index.html#module-type-S">S</a>) <span>&#45;&gt;</span> <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Make with full sig</p></dd></dl><dl><dt class="spec module" id="module-Make_v2"><a href="#module-Make_v2" class="anchor"></a><code><span class="keyword">module</span> <a href="Make_v2/index.html">Make_v2</a> : <span class="keyword">functor</span> (<a href="Make_v2/argument-1-S/index.html">S</a> : <a href="index.html#module-type-S">S</a>) <span>&#45;&gt;</span> <a href="index.html#module-type-T">T</a> <span class="keyword">with</span> <span class="keyword">module</span> <a href="Make_v2/S/index.html">S</a> = <a href="Make_v2/index.html#argument-1-S">S</a></code></dt><dd><p>Make with restricted sig</p></dd></dl><div class="spec module" id="module-Dir_entry"><a href="#module-Dir_entry" class="anchor"></a><code><span class="keyword">module</span> <a href="Dir_entry/index.html">Dir_entry</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec value" id="val-dir_example"><a href="#val-dir_example" class="anchor"></a><code><span class="keyword">val</span> dir_example : <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, <a href="Dir_entry/index.html#type-t">Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.t, <a href="Dir_entry/index.html#type-did">Dir_entry.did</a>)</span> <a href="index.html#type-dir_factory">dir_factory</a></span></code></dt></dl></div></body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sqlite_dir (tjr_impfs.V3_sqlite.Sqlite_dir)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">tjr_impfs</a> &#x00BB; <a href="../index.html">V3_sqlite</a> &#x00BB; Sqlite_dir</nav><header class="odoc-preamble"><h1>Module <code><span>V3_sqlite.Sqlite_dir</span></code></h1><p>An implementation of directories on top of SQLite, for v3.</p><p>Directories consist of two parts:</p><ul><li>The metadata: times (atim,mtim), parent</li><li>The contents: entries pointing to other files and directories</li></ul><p>To implement directories, we need to implement the interface <a href="Dir_ops/index.html"><code>Dir_ops</code></a>.</p><pre><code>type ('k,'v,'t,'did) dir_ops = {
  get_meta  : did:'did -&gt; ('did * times,'t)m;
  find      : did:'did -&gt; 'k -&gt; ('v option,'t) m;
  exec      : ('k,'v,'did) op list -&gt; (unit,'t)m;
  opendir   : did:'did -&gt; (('k,'v,'t)Ls.ops,'t)m;
  max_did   : unit -&gt; 'did; 
  (** NOTE this is blocking, but is intended to be used once at
      startup, so potentially only results in slightly slower startup
      than would be possible if this was in the monad *)

  pre_create: 
    note_does_not_touch_parent: unit -&gt; 
    new_did:'did -&gt; parent:'did -&gt; times:times -&gt; (unit,'t)m; 
  (** pre-create does not touch the parent directory - that needs to
      be done with a separate insert *)
}</code></pre><p>We implement this without a cache: all operations go directly to the database.</p><p>Let's assume that each directory has a unique (int) identifier did. Then we can have a single table dir_entries, with rows <code>(did, name, entry)</code> indexed by did,name (name is unique of course, for a particular did).</p><p>Then <code>find</code>, <code>insert</code> and <code>delete</code> are fine.</p><p>For parent and times, we can have another table (did,parent,times).</p><p><code>opendir</code> creates a reference which pulls upto some limit of elts from the db, and stores the max name so we can resume later on ls_step (the directory entries are stored ordered by name in the database).</p><p>NOTE currently all DB access is serialized; but some concurrency could be achieved</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module" id="module-Times" class="anchored"><a href="#module-Times" class="anchor"></a><code><span><span class="keyword">module</span> </span><span>Times</span><span> = <span class="xref-unresolved">Tjr_fs_shared</span>.Times</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-times" class="anchored"><a href="#type-times" class="anchor"></a><code><span><span class="keyword">type</span> times</span><span> = <span class="xref-unresolved">Times</span>.times</span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Ls" class="anchored"><a href="#module-Ls" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Ls/index.html">Ls</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Directory listing (like a dir handle)</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Op" class="anchored"><a href="#module-Op" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Op/index.html">Op</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Directory operations, to be executed as part of a batch</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Dir_ops" class="anchored"><a href="#module-Dir_ops" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Dir_ops/index.html">Dir_ops</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <span class="keyword">struct</span> <span class="keyword">include</span> <a href="Dir_ops/index.html">Dir_ops</a> <span class="keyword">end</span></span></code></summary><div class="odoc-spec"><div class="spec type" id="type-dir_ops" class="anchored"><a href="#type-dir_ops" class="anchor"></a><code><span><span class="keyword">type</span> <span>('k, 'v, 't, 'did) dir_ops</span></span><span> = <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="Dir_ops/index.html#type-dir_ops">Dir_ops.dir_ops</a></span></span><span> = </span><span>{</span></code><table><tr id="type-dir_ops.get_meta" class="anchored"><td class="def record field"><a href="#type-dir_ops.get_meta" class="anchor"></a><code><span>get_meta : <span>did:<span class="type-var">'did</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'did</span> * <a href="#type-times">times</a>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>;</span></code></td></tr><tr id="type-dir_ops.find" class="anchored"><td class="def record field"><a href="#type-dir_ops.find" class="anchor"></a><code><span>find : <span>did:<span class="type-var">'did</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'k</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="type-var">'v</span> option</span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>;</span></code></td></tr><tr id="type-dir_ops.exec" class="anchored"><td class="def record field"><a href="#type-dir_ops.exec" class="anchor"></a><code><span>exec : <span><span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'did</span>)</span> <a href="Op/index.html#type-op">Op.op</a></span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>;</span></code></td></tr><tr id="type-dir_ops.opendir" class="anchored"><td class="def record field"><a href="#type-dir_ops.opendir" class="anchor"></a><code><span>opendir : <span>did:<span class="type-var">'did</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'t</span>)</span> <a href="Ls/index.html#type-ops">Ls.ops</a></span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>;</span></code></td></tr><tr id="type-dir_ops.max_did" class="anchored"><td class="def record field"><a href="#type-dir_ops.max_did" class="anchor"></a><code><span>max_did : <span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'did</span>;</span></code></td></tr><tr id="type-dir_ops.pre_create" class="anchored"><td class="def record field"><a href="#type-dir_ops.pre_create" class="anchor"></a><code><span>pre_create : <span>note_does_not_touch_parent:unit <span class="arrow">&#45;&gt;</span></span> <span>new_did:<span class="type-var">'did</span> <span class="arrow">&#45;&gt;</span></span> <span>parent:<span class="type-var">'did</span> <span class="arrow">&#45;&gt;</span></span>
<span>times:<a href="#type-times">times</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>NOTE <code>'k</code> is typically &quot;name&quot; of directory entry (a short string); <code>'v</code> is the directory entry itself (a pointer to a file/dir/symlink); we don't assume much about a <code>dir_entry</code> apart from that we can convert it to/from a string/blob.</p><p>Fields are:</p><ul><li><code>get_meta</code> - parent and time info</li><li><code>find</code> a particular entry</li><li><code>exec</code> a list of operations (insert, delete, set parent, set times)</li><li><code>opendir</code> - return a list of entries</li><li><code>max_did</code> - used once on startup, so we can allocate fresh <code>did</code>s; NOTE this is blocking, but is intended to be used once at startup, so potentially only results in slightly slower startup than would be possible if this was in the monad</li><li><code>pre_create</code> which creates a new directory, with a given parent, but does not touch the parent (that has to be done separately)</li></ul></div></div></details></div><div class="odoc-spec"><div class="spec type" id="type-db" class="anchored"><a href="#type-db" class="anchor"></a><code><span><span class="keyword">type</span> db</span><span> = <span class="xref-unresolved">Sqlite3</span>.db</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-create_tables" class="anchored"><a href="#val-create_tables" class="anchor"></a><code><span><span class="keyword">val</span> create_tables : <span><span class="xref-unresolved">Sqlite3</span>.db <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-add_root_directory" class="anchored"><a href="#val-add_root_directory" class="anchor"></a><code><span><span class="keyword">val</span> add_root_directory : <span><span class="xref-unresolved">Sqlite3</span>.db <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-S" class="anchored"><a href="#module-type-S" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> </span><span><a href="module-type-S/index.html">S</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>What the following <a href="Make/index.html"><code>Make</code></a> functor requires; essentially a way to convert <code>dir_entry</code> to/from string.</p></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-T" class="anchored"><a href="#module-type-T" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> </span><span><a href="module-type-T/index.html">T</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>What the following <a href="Make/index.html"><code>Make</code></a> functor provides</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Make" class="anchored"><a href="#module-Make" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Make/index.html">Make</a></span><span> (<a href="Make/argument-1-S/index.html">S</a> : <a href="module-type-S/index.html">S</a>) : <a href="module-type-T/index.html">T</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="module-type-T/index.html#type-did">did</a> := <a href="Make/argument-1-S/index.html#type-did">S.did</a></span> <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="module-type-T/index.html#type-dir_entry">dir_entry</a> := <a href="Make/argument-1-S/index.html#type-dir_entry">S.dir_entry</a></span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Test" class="anchored"><a href="#module-Test" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Test/index.html">Test</a></span><span> () : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
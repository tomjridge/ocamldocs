<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Stage_2 (tjr_impfs.Tjr_impfs__V2.Stage_1.Stage_2)</title><link rel="stylesheet" href="../../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../../index.html">tjr_impfs</a> &#x00BB; <a href="../../index.html">Tjr_impfs__V2</a> &#x00BB; <a href="../index.html">Stage_1</a> &#x00BB; Stage_2</nav><h1>Module <code>Stage_1.Stage_2</code></h1><p>Stage_2: we assume freelist_ops, gom_ops and counter_ops are available</p><nav class="toc"><ul><li><a href="#blk-allocator-using-freelist">Blk allocator using freelist</a></li><li><a href="#dirs">Dirs</a></li><li><a href="#extra-ops">Extra ops</a></li></ul></nav></header><h3 class="heading">Parameters</h3><ul><li><code><a href="argument-1-S2/index.html">S2</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></li></ul><h3 class="heading">Signature</h3><dl><dt class="spec value" id="val-new_id"><a href="#val-new_id" class="anchor"></a><code><span class="keyword">val</span> new_id : unit <span>&#45;&gt;</span> <span><span>(int, <a href="../../S0/index.html#type-t">S0.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-new_did"><a href="#val-new_did" class="anchor"></a><code><span class="keyword">val</span> new_did : unit <span>&#45;&gt;</span> <span><span>(int, <a href="../../S0/index.html#type-t">S0.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-new_fid"><a href="#val-new_fid" class="anchor"></a><code><span class="keyword">val</span> new_fid : unit <span>&#45;&gt;</span> <span><span>(int, <a href="../../S0/index.html#type-t">S0.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-new_sid"><a href="#val-new_sid" class="anchor"></a><code><span class="keyword">val</span> new_sid : unit <span>&#45;&gt;</span> <span><span>(int, <a href="../../S0/index.html#type-t">S0.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-id_to_int"><a href="#val-id_to_int" class="anchor"></a><code><span class="keyword">val</span> id_to_int : <span><span>(<span class="type-var">'a</span>, <span class="type-var">'a</span>, <span class="type-var">'a</span>)</span> <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-dir_entry'">Tjr_impfs.Dir_impl.Dir_entry.dir_entry'</a></span> <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt><dt class="spec value" id="val-root_did"><a href="#val-root_did" class="anchor"></a><code><span class="keyword">val</span> root_did : int</code></dt></dl><section><header><h3 id="blk-allocator-using-freelist"><a href="#blk-allocator-using-freelist" class="anchor"></a>Blk allocator using freelist</h3></header></section><section><header><h3 id="dirs"><a href="#dirs" class="anchor"></a>Dirs</h3></header><dl><dt class="spec value" id="val-gom_find_opt"><a href="#val-gom_find_opt" class="anchor"></a><code><span class="keyword">val</span> gom_find_opt : <a href="../../index.html#type-dir_entry">dir_entry</a> <span>&#45;&gt;</span> <span><span>(<span>Tjr_fs_shared.Shared_ctxt.blk_id option</span>, <a href="../../S0/index.html#type-t">S0.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-gom_find"><a href="#val-gom_find" class="anchor"></a><code><span class="keyword">val</span> gom_find : <a href="../../index.html#type-dir_entry">dir_entry</a> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.blk_id, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-gom_insert"><a href="#val-gom_insert" class="anchor"></a><code><span class="keyword">val</span> gom_insert : <a href="../../index.html#type-dir_entry">dir_entry</a> <span>&#45;&gt;</span> Tjr_fs_shared.Shared_ctxt.blk_id <span>&#45;&gt;</span> <span><span>(unit, <a href="../../S0/index.html#type-t">S0.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-gom_delete"><a href="#val-gom_delete" class="anchor"></a><code><span class="keyword">val</span> gom_delete : <a href="../../index.html#type-dir_entry">dir_entry</a> <span>&#45;&gt;</span> <span><span>(unit, <a href="../../S0/index.html#type-t">S0.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-dir_impl"><a href="#val-dir_impl" class="anchor"></a><code><span class="keyword">val</span> dir_impl : <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-t">Tjr_impfs.Dir_impl.Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.t, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-did">Tjr_impfs.Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Tjr_impfs/Dir_impl/index.html#type-dir_factory">Tjr_impfs.Dir_impl.dir_factory</a></span></code></dt><dt class="spec value" id="val-dir_impl'"><a href="#val-dir_impl'" class="anchor"></a><code><span class="keyword">val</span> dir_impl' : &lt; alloc_via_usedlist : <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/Usedlist_impl/Usedlist/index.html#type-ops">Tjr_impfs.Usedlist_impl.Usedlist.ops</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_fs_shared.blk_allocator_ops</span>; create_dir : <span>parent:<a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-did">Tjr_impfs.Dir_impl.Dir_entry.did</a></span> <span>&#45;&gt;</span> <span>times:<a href="../../../Tjr_impfs/Dir_impl/index.html#type-stat_times">Tjr_impfs.Dir_impl.stat_times</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; dir_add_autosync : Tjr_fs_shared.Shared_ctxt.r <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.str_256, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-t">Tjr_impfs.Dir_impl.Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-did">Tjr_impfs.Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Tjr_impfs/Dir_impl/Dir_ops/index.html#type-t">Tjr_impfs.Dir_impl.Dir_ops.t</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.str_256, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-t">Tjr_impfs.Dir_impl.Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-did">Tjr_impfs.Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Tjr_impfs/Dir_impl/Dir_ops/index.html#type-t">Tjr_impfs.Dir_impl.Dir_ops.t</a></span>; dir_from_origin : Tjr_fs_shared.Shared_ctxt.r <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.str_256, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-t">Tjr_impfs.Dir_impl.Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-did">Tjr_impfs.Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Tjr_impfs/Dir_impl/Dir_ops/index.html#type-t">Tjr_impfs.Dir_impl.Dir_ops.t</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; dir_from_origin_blk : <span>(Tjr_fs_shared.Shared_ctxt.r * <span><span>(Tjr_fs_shared.Shared_ctxt.r, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-did">Tjr_impfs.Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Tjr_impfs/Dir_impl/Dir_origin/index.html#type-t">Tjr_impfs.Dir_impl.Dir_origin.t</a></span>)</span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.str_256, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-t">Tjr_impfs.Dir_impl.Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-did">Tjr_impfs.Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Tjr_impfs/Dir_impl/Dir_ops/index.html#type-t">Tjr_impfs.Dir_impl.Dir_ops.t</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; mk_dir : <span>usedlist:<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/Usedlist_impl/Usedlist/index.html#type-ops">Tjr_impfs.Usedlist_impl.Usedlist.ops</a></span></span> <span>&#45;&gt;</span> <span>btree_root:Tjr_fs_shared.Shared_ctxt.r</span> <span>&#45;&gt;</span> <span>with_dir:<span><span>(<span><a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-did">Tjr_impfs.Dir_impl.Dir_entry.did</a> <a href="../../../Tjr_impfs/Dir_impl/Dir_im/index.html#type-dir_im">Tjr_impfs.Dir_impl.Dir_im.dir_im</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.with_state</span></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.str_256, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-t">Tjr_impfs.Dir_impl.Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t, <a href="../../../Tjr_impfs/Dir_impl/Dir_entry/index.html#type-did">Tjr_impfs.Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Tjr_impfs/Dir_impl/Dir_ops/index.html#type-t">Tjr_impfs.Dir_impl.Dir_ops.t</a></span>; usedlist_ops : <span>Tjr_fs_shared.Shared_ctxt.r <a href="../../../Tjr_impfs/Usedlist_impl/Usedlist/index.html#type-origin">Tjr_impfs.Usedlist_impl.Usedlist.origin</a></span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/Usedlist_impl/Usedlist/index.html#type-ops">Tjr_impfs.Usedlist_impl.Usedlist.ops</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; &gt;</code></dt><dt class="spec value" id="val-dirs"><a href="#val-dirs" class="anchor"></a><code><span class="keyword">val</span> dirs : <a href="../../Make/S1/index.html#type-dirs_ops">S1.dirs_ops</a></code></dt><dt class="spec value" id="val-file_impl"><a href="#val-file_impl" class="anchor"></a><code><span class="keyword">val</span> file_impl : <span><span>(Tjr_fs_shared.ba_buf, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/File_impl_v2/index.html#type-file_factory">Tjr_impfs.File_impl_v2.file_factory</a></span></code></dt><dt class="spec value" id="val-file_impl'"><a href="#val-file_impl'" class="anchor"></a><code><span class="keyword">val</span> file_impl' : &lt; alloc_via_usedlist : <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/Fv2_types/Usedlist/index.html#type-ops">Tjr_impfs.Fv2_types.Usedlist.ops</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_fs_shared.blk_allocator_ops</span>; create_file : <a href="../../../Tjr_impfs/Fv2_types/index.html#type-stat_times">Tjr_impfs.Fv2_types.stat_times</a> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; file_from_origin : Tjr_fs_shared.Shared_ctxt.r <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/File_impl_v2/index.html#type-file_ops">Tjr_impfs.File_impl_v2.file_ops</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; file_from_origin_blk : <span>(Tjr_fs_shared.Shared_ctxt.r * <span>Tjr_fs_shared.Shared_ctxt.r <a href="../../../Tjr_impfs/File_impl_v2/File_origin_block/index.html#type-t">Tjr_impfs.File_impl_v2.File_origin_block.t</a></span>)</span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/File_impl_v2/index.html#type-file_ops">Tjr_impfs.File_impl_v2.file_ops</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; file_ops : <span>usedlist:<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/Fv2_types/Usedlist/index.html#type-ops">Tjr_impfs.Fv2_types.Usedlist.ops</a></span></span> <span>&#45;&gt;</span> <span>alloc_via_usedlist:<span>(unit <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>)</span></span> <span>&#45;&gt;</span> <span>blk_idx_map:<span><span>(int, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/Fv2_types/Btree_ops/index.html#type-t">Tjr_impfs.Fv2_types.Btree_ops.t</a></span></span> <span>&#45;&gt;</span> <span>file_origin:Tjr_fs_shared.Shared_ctxt.r</span> <span>&#45;&gt;</span> <span>init_file_size:int</span> <span>&#45;&gt;</span> <span>init_times:<a href="../../../Tjr_impfs/Fv2_types/index.html#type-stat_times">Tjr_impfs.Fv2_types.stat_times</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/File_impl_v2/index.html#type-file_ops">Tjr_impfs.File_impl_v2.file_ops</a></span>; mk_blk_idx_map : <span>usedlist:<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/Fv2_types/Usedlist/index.html#type-ops">Tjr_impfs.Fv2_types.Usedlist.ops</a></span></span> <span>&#45;&gt;</span> <span>btree_root:Tjr_fs_shared.Shared_ctxt.r</span> <span>&#45;&gt;</span> <span><span>(int, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/Fv2_types/Btree_ops/index.html#type-t">Tjr_impfs.Fv2_types.Btree_ops.t</a></span>; usedlist_ops : <span>Tjr_fs_shared.Shared_ctxt.r <a href="../../../Tjr_impfs/Fv2_types/Usedlist/index.html#type-origin">Tjr_impfs.Fv2_types.Usedlist.origin</a></span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/Fv2_types/Usedlist/index.html#type-ops">Tjr_impfs.Fv2_types.Usedlist.ops</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; &gt;</code></dt><dt class="spec value" id="val-symlink_impl"><a href="#val-symlink_impl" class="anchor"></a><code><span class="keyword">val</span> symlink_impl : <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.buf, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Tjr_impfs/Symlink_impl/index.html#type-symlink_factory">Tjr_impfs.Symlink_impl.symlink_factory</a></span></code></dt><dt class="spec value" id="val-symlink_impl'"><a href="#val-symlink_impl'" class="anchor"></a><code><span class="keyword">val</span> symlink_impl' : &lt; create_symlink : Tjr_fs_shared.str_256 <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; &gt;</code></dt><dt class="spec value" id="val-files"><a href="#val-files" class="anchor"></a><code><span class="keyword">val</span> files : <a href="../../Make/S1/index.html#type-files_ops">S1.files_ops</a></code></dt><dt class="spec value" id="val-read_symlink"><a href="#val-read_symlink" class="anchor"></a><code><span class="keyword">val</span> read_symlink : <a href="../../S0/index.html#type-sid">S0.sid</a> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.str_256, <a href="../../S0/index.html#type-t">S0.t</a>)</span> Tjr_monad.m</span></code></dt></dl><dl><dt class="spec value" id="val-resolve_comp"><a href="#val-resolve_comp" class="anchor"></a><code><span class="keyword">val</span> resolve_comp : <a href="../../S0/index.html#type-did">S0.did</a> <span>&#45;&gt;</span> Tjr_path_resolution.Intf.comp_ <span>&#45;&gt;</span> <span><span>(<span><span>(<a href="../../S0/index.html#type-fid">S0.fid</a>, <a href="../../S0/index.html#type-did">S0.did</a>)</span> Tjr_path_resolution.Intf.resolved_comp</span>, <a href="../../S0/index.html#type-t">S0.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-fs_ops"><a href="#val-fs_ops" class="anchor"></a><code><span class="keyword">val</span> fs_ops : <span><span>(<a href="../../S0/index.html#type-fid">S0.fid</a>, <a href="../../S0/index.html#type-did">S0.did</a>, <a href="../../S0/index.html#type-t">S0.t</a>)</span> Tjr_path_resolution.Intf.fs_ops</span></code></dt><dt class="spec value" id="val-resolve"><a href="#val-resolve" class="anchor"></a><code><span class="keyword">val</span> resolve : <span>follow_last_symlink:Tjr_path_resolution.follow_last_symlink</span> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <span><span>(<span><span>(<a href="../../S0/index.html#type-fid">S0.fid</a>, <a href="../../S0/index.html#type-did">S0.did</a>)</span> Tjr_path_resolution.resolved_path_or_err</span>, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-resolve_path"><a href="#val-resolve_path" class="anchor"></a><code><span class="keyword">val</span> resolve_path : <span>follow_last_symlink:Tjr_path_resolution.follow_last_symlink</span> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <span><span>(<span><span>(<a href="../../S0/index.html#type-fid">S0.fid</a>, <a href="../../S0/index.html#type-did">S0.did</a>)</span> Tjr_path_resolution.resolved_path_or_err</span>, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-mk_stat_times"><a href="#val-mk_stat_times" class="anchor"></a><code><span class="keyword">val</span> mk_stat_times : unit <span>&#45;&gt;</span> <span><span>(Tjr_minifs.Minifs_intf.Times.times, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt></dl></section><section><header><h3 id="extra-ops"><a href="#extra-ops" class="anchor"></a>Extra ops</h3></header><dl><dt class="spec value" id="val-extra"><a href="#val-extra" class="anchor"></a><code><span class="keyword">val</span> extra : <a href="../../Make/S1/index.html#type-extra_ops">S1.extra_ops</a></code></dt></dl></section></div></body></html>
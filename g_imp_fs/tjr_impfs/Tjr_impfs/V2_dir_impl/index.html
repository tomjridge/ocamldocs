<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>V2_dir_impl (tjr_impfs.Tjr_impfs.V2_dir_impl)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">tjr_impfs</a> &#x00BB; <a href="../index.html">Tjr_impfs</a> &#x00BB; V2_dir_impl</nav><header class="odoc-preamble"><h1>Module <code><span>Tjr_impfs.V2_dir_impl</span></code></h1></header><div class="odoc-content"><p>A simple directory implementation using a B-tree; NOTE this module safe to open.</p><p>Directories are one of the main objects we deal with.</p><p>We implement a directory as a map from name (string, max length 256 bytes) to entry (file, directory or symlink). Of course, this uses an underlying B-tree.</p><p>Any used blocks are recorded in a per-directory-object used list. Currently, blocks are only reclaimed when the directory is deleted. Later, we plan to implement cleaning of directories that are still live, to free up blocks that are no longer used.</p><p>We reuse the usedlist implementation from <a href="../File_impl_v2/index.html"><code>File_impl_v2</code></a>.</p><p>A directory is really a thin layer over a B-tree, interfacing with the used list, and handling the origin block.</p><div class="odoc-spec"><div class="spec type" id="type-stat_times" class="anchored"><a href="#type-stat_times" class="anchor"></a><code><span><span class="keyword">type</span> stat_times</span><span> = <span class="xref-unresolved">Tjr_minifs</span>.Minifs_intf.times</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-bin_shape_stat_times" class="anchored"><a href="#val-bin_shape_stat_times" class="anchor"></a><code><span><span class="keyword">val</span> bin_shape_stat_times : <span class="xref-unresolved">Bin_prot</span>.Shape.t</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-bin_size_stat_times" class="anchored"><a href="#val-bin_size_stat_times" class="anchor"></a><code><span><span class="keyword">val</span> bin_size_stat_times : <span><a href="#type-stat_times">stat_times</a> <span class="xref-unresolved">Bin_prot</span>.Size.sizer</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-bin_write_stat_times" class="anchored"><a href="#val-bin_write_stat_times" class="anchor"></a><code><span><span class="keyword">val</span> bin_write_stat_times : <span><a href="#type-stat_times">stat_times</a> <span class="xref-unresolved">Bin_prot</span>.Write.writer</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-bin_writer_stat_times" class="anchored"><a href="#val-bin_writer_stat_times" class="anchor"></a><code><span><span class="keyword">val</span> bin_writer_stat_times : <span><a href="#type-stat_times">stat_times</a> <span class="xref-unresolved">Bin_prot</span>.Type_class.writer</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-__bin_read_stat_times__" class="anchored"><a href="#val-__bin_read_stat_times__" class="anchor"></a><code><span><span class="keyword">val</span> __bin_read_stat_times__ : <span><span>(<span>int <span class="arrow">&#45;&gt;</span></span> <a href="#type-stat_times">stat_times</a>)</span> <span class="xref-unresolved">Bin_prot</span>.Read.reader</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-bin_read_stat_times" class="anchored"><a href="#val-bin_read_stat_times" class="anchor"></a><code><span><span class="keyword">val</span> bin_read_stat_times : <span><a href="#type-stat_times">stat_times</a> <span class="xref-unresolved">Bin_prot</span>.Read.reader</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-bin_reader_stat_times" class="anchored"><a href="#val-bin_reader_stat_times" class="anchor"></a><code><span><span class="keyword">val</span> bin_reader_stat_times : <span><a href="#type-stat_times">stat_times</a> <span class="xref-unresolved">Bin_prot</span>.Type_class.reader</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-bin_stat_times" class="anchored"><a href="#val-bin_stat_times" class="anchor"></a><code><span><span class="keyword">val</span> bin_stat_times : <span><a href="#type-stat_times">stat_times</a> <span class="xref-unresolved">Bin_prot</span>.Type_class.t</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Dir_origin" class="anchored"><a href="#module-Dir_origin" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Dir_origin/index.html">Dir_origin</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Dir_ops" class="anchored"><a href="#module-Dir_ops" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Dir_ops/index.html">Dir_ops</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Dir_im" class="anchored"><a href="#module-Dir_im" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Dir_im/index.html">Dir_im</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>What we keep in memory to represent a dir (in addition to the used list and the dir map)</p></div></div><div class="odoc-spec"><div class="spec type" id="type-dir_factory" class="anchored"><a href="#type-dir_factory" class="anchor"></a><code><span><span class="keyword">type</span> <span>('blk_id, 'blk, 'de, 't, 'did) dir_factory</span></span><span> = <span>&lt; read_origin : <span>blk_dev_ops:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'blk</span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_fs_shared</span>.blk_dev_ops</span> <span class="arrow">&#45;&gt;</span></span>
<span>blk_id:<span class="type-var">'blk_id</span> <span class="arrow">&#45;&gt;</span></span>
<span><span>(<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'did</span>)</span> <a href="Dir_origin/index.html#type-t">Dir_origin.t</a></span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>; write_origin : <span>blk_dev_ops:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'blk</span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_fs_shared</span>.blk_dev_ops</span>
<span class="arrow">&#45;&gt;</span></span> <span>blk_id:<span class="type-var">'blk_id</span> <span class="arrow">&#45;&gt;</span></span> <span>origin:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'did</span>)</span> <a href="Dir_origin/index.html#type-t">Dir_origin.t</a></span> <span class="arrow">&#45;&gt;</span></span>
<span><span>(unit, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>; with_ : <span>blk_dev_ops:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'blk</span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_fs_shared</span>.blk_dev_ops</span> <span class="arrow">&#45;&gt;</span></span>
<span>barrier:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span>sync:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>)</span> <span class="arrow">&#45;&gt;</span></span>
<span>freelist_ops:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> <a href="../Freelist_intf/index.html#type-freelist_ops">Freelist_intf.freelist_ops</a></span> <span class="arrow">&#45;&gt;</span></span>
<span>&lt; usedlist_ops : <span><span><span class="type-var">'blk_id</span> <a href="../V2_usedlist_impl/Usedlist/index.html#type-origin">V2_usedlist_impl.Usedlist.origin</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> <a href="../V2_usedlist_impl/Usedlist/index.html#type-ops">V2_usedlist_impl.Usedlist.ops</a></span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>; alloc_via_usedlist : <span><span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> <a href="../V2_usedlist_impl/Usedlist/index.html#type-ops">V2_usedlist_impl.Usedlist.ops</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_fs_shared</span>.blk_allocator_ops</span>; mk_dir : <span>usedlist:<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> <a href="../V2_usedlist_impl/Usedlist/index.html#type-ops">V2_usedlist_impl.Usedlist.ops</a></span>
<span class="arrow">&#45;&gt;</span></span> <span>btree_root:<span class="type-var">'blk_id</span> <span class="arrow">&#45;&gt;</span></span> <span>with_dir:<span><span>(<span><span class="type-var">'did</span> <a href="Dir_im/index.html#type-dir_im">Dir_im.dir_im</a></span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.with_state</span> <span class="arrow">&#45;&gt;</span></span>
<span><span>(<span class="xref-unresolved">Tjr_fs_shared</span>.str_256, <span class="type-var">'de</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="Dir_ops/index.html#type-t">Dir_ops.t</a></span>; create_root_dir : <span>root_did:<span class="type-var">'did</span> <span class="arrow">&#45;&gt;</span></span>
<span>times:<a href="#type-stat_times">stat_times</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>; create_dir : <span>parent:<span class="type-var">'did</span> <span class="arrow">&#45;&gt;</span></span> <span>times:<a href="#type-stat_times">stat_times</a> <span class="arrow">&#45;&gt;</span></span>
<span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>; dir_add_autosync : <span><span class="type-var">'blk_id</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="xref-unresolved">Tjr_fs_shared</span>.str_256, <span class="type-var">'de</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="Dir_ops/index.html#type-t">Dir_ops.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="xref-unresolved">Tjr_fs_shared</span>.str_256, <span class="type-var">'de</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="Dir_ops/index.html#type-t">Dir_ops.t</a></span>; dir_from_origin_blk : <span><span>(<span class="type-var">'blk_id</span> * <span><span>(<span class="type-var">'blk_id</span>, <span class="type-var">'did</span>)</span> <a href="Dir_origin/index.html#type-t">Dir_origin.t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span>(<span class="xref-unresolved">Tjr_fs_shared</span>.str_256, <span class="type-var">'de</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="Dir_ops/index.html#type-t">Dir_ops.t</a></span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>; dir_from_origin : <span><span class="type-var">'blk_id</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span>(<span class="xref-unresolved">Tjr_fs_shared</span>.str_256, <span class="type-var">'de</span>, <span class="type-var">'blk_id</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="Dir_ops/index.html#type-t">Dir_ops.t</a></span>, <span class="type-var">'t</span>)</span> <span class="xref-unresolved">Tjr_monad</span>.m</span>; &gt;</span>; &gt;</span></span></code></div><div class="spec-doc"><p>NOTE 'de stands for dir_entry</p></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-S" class="anchored"><a href="#module-type-S" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> </span><span><a href="module-type-S/index.html">S</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-T" class="anchored"><a href="#module-type-T" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> </span><span><a href="module-type-T/index.html">T</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Make_v1" class="anchored"><a href="#module-Make_v1" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Make_v1/index.html">Make_v1</a></span><span> (<a href="Make_v1/argument-1-S/index.html">S</a> : <a href="module-type-S/index.html">S</a>) : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Make with full sig</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Make_v2" class="anchored"><a href="#module-Make_v2" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Make_v2/index.html">Make_v2</a></span><span> (<a href="Make_v2/argument-1-S/index.html">S</a> : <a href="module-type-S/index.html">S</a>) : <a href="module-type-T/index.html">T</a> <span class="keyword">with</span> <span><span class="keyword">module</span> <a href="module-type-T/S/index.html">S</a> = <a href="Make_v2/argument-1-S/index.html">S</a></span></span></code></div><div class="spec-doc"><p>Make with restricted sig</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Dir_entry" class="anchored"><a href="#module-Dir_entry" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Dir_entry/index.html">Dir_entry</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-dir_example" class="anchored"><a href="#val-dir_example" class="anchor"></a><code><span><span class="keyword">val</span> dir_example : <span><span>(<span class="xref-unresolved">Tjr_fs_shared</span>.Shared_ctxt.r, <span class="xref-unresolved">Tjr_fs_shared</span>.Shared_ctxt.blk, <a href="Dir_entry/index.html#type-t">Dir_entry.t</a>, <span class="xref-unresolved">Tjr_fs_shared</span>.Shared_ctxt.t, <a href="Dir_entry/index.html#type-did">Dir_entry.did</a>)</span> <a href="#type-dir_factory">dir_factory</a></span></span></code></div></div></div></body></html>
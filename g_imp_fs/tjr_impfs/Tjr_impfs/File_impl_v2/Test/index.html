<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Test (tjr_impfs.Tjr_impfs.File_impl_v2.Test)</title><link rel="stylesheet" href="../../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../../index.html">tjr_impfs</a> &#x00BB; <a href="../../index.html">Tjr_impfs</a> &#x00BB; <a href="../index.html">File_impl_v2</a> &#x00BB; Test</nav><h1>Module <code>File_impl_v2.Test</code></h1><p>Test the file_example with</p><ul><li>monad is Shared_ctxt.t</li><li>blk_dev is in-memory, map from blk_id to blk; barrier and sync are no-ops</li><li>blk_id is blk_id_as_int</li><li>freelist_ops is a dummy counter</li><li>usedlist is a dummy; alloc_via_usedlist uses the usedlist</li><li>blk_idx_map is a ref (to a map from int to blk_id)</li><li>file_origin is a dummy blk_id -1</li><li>file_size is 0 initially</li></ul></header><h3 class="heading">Parameters</h3><ul></ul><h3 class="heading">Signature</h3><dl><dt class="spec value" id="val-monad_ops"><a href="#val-monad_ops" class="anchor"></a><code><span class="keyword">val</span> monad_ops : <span>Tjr_monad.With_lwt.lwt Tjr_monad__.Monad_intf.monad_ops</span></code></dt><dt class="spec value" id="val-(&gt;&gt;=)"><a href="#val-(&gt;&gt;=)" class="anchor"></a><code><span class="keyword">val</span> (&gt;&gt;=) : <span><span>(<span class="type-var">'a</span>, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span> <span>&#45;&gt;</span> <span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'b</span>, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span>)</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'b</span>, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-return"><a href="#val-return" class="anchor"></a><code><span class="keyword">val</span> return : <span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-example"><a href="#val-example" class="anchor"></a><code><span class="keyword">val</span> example : <span><span>(Tjr_fs_shared.ba_buf, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../index.html#type-file_factory">file_factory</a></span></code></dt><dt class="spec value" id="val-blk_sz"><a href="#val-blk_sz" class="anchor"></a><code><span class="keyword">val</span> blk_sz : Tjr_fs_shared.Blk_sz.blk_sz</code></dt></dl><dl><dt class="spec type" id="type-blk_id"><a href="#type-blk_id" class="anchor"></a><code><span class="keyword">type</span> blk_id</code><code> = Tjr_fs_shared.Shared_ctxt.blk_id</code></dt><dt class="spec type" id="type-blk"><a href="#type-blk" class="anchor"></a><code><span class="keyword">type</span> blk</code><code> = Tjr_fs_shared.ba_buf</code></dt></dl><div class="spec module" id="module-Blk_dev_im"><a href="#module-Blk_dev_im" class="anchor"></a><code><span class="keyword">module</span> <a href="Blk_dev_im/index.html">Blk_dev_im</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec value" id="val-blk_dev_ops"><a href="#val-blk_dev_ops" class="anchor"></a><code><span class="keyword">val</span> blk_dev_ops : <span><span>(<a href="Blk_dev_im/M/index.html#type-key">Blk_dev_im.M.key</a>, Tjr_fs_shared.ba_buf, Tjr_monad.With_lwt.lwt)</span> Tjr_fs_shared.blk_dev_ops</span></code></dt><dt class="spec value" id="val-barrier"><a href="#val-barrier" class="anchor"></a><code><span class="keyword">val</span> barrier : unit <span>&#45;&gt;</span> <span><span>(unit, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-sync"><a href="#val-sync" class="anchor"></a><code><span class="keyword">val</span> sync : unit <span>&#45;&gt;</span> <span><span>(unit, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt></dl><div class="spec module" id="module-Freelist_im"><a href="#module-Freelist_im" class="anchor"></a><code><span class="keyword">module</span> <a href="Freelist_im/index.html">Freelist_im</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec value" id="val-freelist_ops"><a href="#val-freelist_ops" class="anchor"></a><code><span class="keyword">val</span> freelist_ops : <span><span>(Tjr_fs_shared.Blk_id_as_int.blk_id, Tjr_fs_shared.Shared_ctxt.r, Tjr_monad.With_lwt.lwt)</span> Tjr_plist_freelist.Freelist_intf.freelist_ops</span></code></dt><dt class="spec value" id="val-with_"><a href="#val-with_" class="anchor"></a><code><span class="keyword">val</span> with_ : &lt; alloc_via_usedlist : <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../Usedlist_impl/Usedlist/index.html#type-ops">Usedlist_impl.Usedlist.ops</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_fs_shared.blk_allocator_ops</span>; create_file : <a href="../../Fv2_types/index.html#type-stat_times">Fv2_types.stat_times</a> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; file_from_origin : Tjr_fs_shared.Shared_ctxt.r <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../index.html#type-file_ops">file_ops</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; file_from_origin_blk : <span>(Tjr_fs_shared.Shared_ctxt.r * <span>Tjr_fs_shared.Shared_ctxt.r <a href="../File_origin_block/index.html#type-t">File_origin_block.t</a></span>)</span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../index.html#type-file_ops">file_ops</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; file_ops : <span>usedlist:<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../Usedlist_impl/Usedlist/index.html#type-ops">Usedlist_impl.Usedlist.ops</a></span></span> <span>&#45;&gt;</span> <span>alloc_via_usedlist:<span>(unit <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>)</span></span> <span>&#45;&gt;</span> <span>blk_idx_map:<span><span>(int, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../Fv2_types/Btree_ops/index.html#type-t">Fv2_types.Btree_ops.t</a></span></span> <span>&#45;&gt;</span> <span>file_origin:Tjr_fs_shared.Shared_ctxt.r</span> <span>&#45;&gt;</span> <span>init_file_size:int</span> <span>&#45;&gt;</span> <span>init_times:<a href="../../Fv2_types/index.html#type-stat_times">Fv2_types.stat_times</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../index.html#type-file_ops">file_ops</a></span>; mk_blk_idx_map : <span>usedlist:<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../Usedlist_impl/Usedlist/index.html#type-ops">Usedlist_impl.Usedlist.ops</a></span></span> <span>&#45;&gt;</span> <span>btree_root:Tjr_fs_shared.Shared_ctxt.r</span> <span>&#45;&gt;</span> <span><span>(int, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../Fv2_types/Btree_ops/index.html#type-t">Fv2_types.Btree_ops.t</a></span>; usedlist_ops : <span>Tjr_fs_shared.Shared_ctxt.r <a href="../../Usedlist_impl/Usedlist/index.html#type-origin">Usedlist_impl.Usedlist.origin</a></span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../Usedlist_impl/Usedlist/index.html#type-ops">Usedlist_impl.Usedlist.ops</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; &gt;</code></dt><dt class="spec value" id="val-file_ops"><a href="#val-file_ops" class="anchor"></a><code><span class="keyword">val</span> file_ops : <span>usedlist:<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../Usedlist_impl/Usedlist/index.html#type-ops">Usedlist_impl.Usedlist.ops</a></span></span> <span>&#45;&gt;</span> <span>alloc_via_usedlist:<span>(unit <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>)</span></span> <span>&#45;&gt;</span> <span>blk_idx_map:<span><span>(int, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../Fv2_types/Btree_ops/index.html#type-t">Fv2_types.Btree_ops.t</a></span></span> <span>&#45;&gt;</span> <span>file_origin:Tjr_fs_shared.Shared_ctxt.r</span> <span>&#45;&gt;</span> <span>init_file_size:int</span> <span>&#45;&gt;</span> <span>init_times:<a href="../../Fv2_types/index.html#type-stat_times">Fv2_types.stat_times</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../index.html#type-file_ops">file_ops</a></span></code></dt><dt class="spec value" id="val-usedlist"><a href="#val-usedlist" class="anchor"></a><code><span class="keyword">val</span> usedlist : unit <span>&#45;&gt;</span> &lt; ops : <span><span>(<span class="type-var">'blk_id</span>, Tjr_monad.With_lwt.lwt)</span> <a href="../../Usedlist_impl/Usedlist/index.html#type-usedlist_ops">Usedlist_impl.Usedlist.usedlist_ops</a></span>; ref_ : <span><span><span class="type-var">'blk_id</span> list</span> Stdlib.ref</span>; &gt;</code></dt><dt class="spec value" id="val-usedlist"><a href="#val-usedlist" class="anchor"></a><code><span class="keyword">val</span> usedlist : <span><span>(Tjr_fs_shared.Blk_id_as_int.blk_id, Tjr_monad.With_lwt.lwt)</span> <a href="../../Usedlist_impl/Usedlist/index.html#type-usedlist_ops">Usedlist_impl.Usedlist.usedlist_ops</a></span></code></dt><dt class="spec value" id="val-alloc_via_usedlist"><a href="#val-alloc_via_usedlist" class="anchor"></a><code><span class="keyword">val</span> alloc_via_usedlist : unit <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Blk_id_as_int.blk_id, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt></dl><div class="spec module" id="module-Blk_idx_map"><a href="#module-Blk_idx_map" class="anchor"></a><code><span class="keyword">module</span> <a href="Blk_idx_map/index.html">Blk_idx_map</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec value" id="val-blk_idx_map_ref"><a href="#val-blk_idx_map_ref" class="anchor"></a><code><span class="keyword">val</span> blk_idx_map_ref : <span><span><a href="index.html#type-blk_id">blk_id</a> <a href="Blk_idx_map/M/index.html#type-t">Blk_idx_map.M.t</a></span> Stdlib.ref</span></code></dt><dt class="spec value" id="val-with_state"><a href="#val-with_state" class="anchor"></a><code><span class="keyword">val</span> with_state : <span><span>(<span><a href="index.html#type-blk_id">blk_id</a> <a href="Blk_idx_map/M/index.html#type-t">Blk_idx_map.M.t</a></span>, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.with_state</span></code></dt><dt class="spec value" id="val-blk_idx_map"><a href="#val-blk_idx_map" class="anchor"></a><code><span class="keyword">val</span> blk_idx_map : <span><span>(<a href="Blk_idx_map/M/index.html#type-key">Blk_idx_map.M.key</a>, <a href="index.html#type-blk_id">blk_id</a>, Tjr_fs_shared.Blk_id_as_int.blk_id, Tjr_monad.lwt)</span> <a href="../../Fv2_types/Btree_ops/index.html#type-t">Fv2_types.Btree_ops.t</a></span></code></dt><dt class="spec value" id="val-file_origin"><a href="#val-file_origin" class="anchor"></a><code><span class="keyword">val</span> file_origin : Tjr_fs_shared.Blk_id_as_int.blk_id</code></dt><dt class="spec value" id="val-init_file_size"><a href="#val-init_file_size" class="anchor"></a><code><span class="keyword">val</span> init_file_size : int</code></dt><dt class="spec value" id="val-init_times"><a href="#val-init_times" class="anchor"></a><code><span class="keyword">val</span> init_times : <a href="../index.html#module-Times">Times</a>.times</code></dt><dt class="spec value" id="val-file_ops"><a href="#val-file_ops" class="anchor"></a><code><span class="keyword">val</span> file_ops : <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../index.html#type-file_ops">file_ops</a></span></code></dt><dt class="spec value" id="val-pwrite"><a href="#val-pwrite" class="anchor"></a><code><span class="keyword">val</span> pwrite : <span>src:Tjr_fs_shared.ba_buf</span> <span>&#45;&gt;</span> <span>src_off:Tjr_fs_shared.Int_like.offset</span> <span>&#45;&gt;</span> <span>src_len:Tjr_fs_shared.Int_like.len</span> <span>&#45;&gt;</span> <span>dst_off:Tjr_fs_shared.Int_like.offset</span> <span>&#45;&gt;</span> <span><span>(<span><span>(int, <a href="../index.html#type-pwrite_error">pwrite_error</a>)</span> Stdlib.result</span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-pread"><a href="#val-pread" class="anchor"></a><code><span class="keyword">val</span> pread : <span>off:Tjr_fs_shared.Int_like.offset</span> <span>&#45;&gt;</span> <span>len:Tjr_fs_shared.Int_like.len</span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.ba_buf, <a href="../index.html#type-pread_error">pread_error</a>)</span> Stdlib.result</span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-buf_ops"><a href="#val-buf_ops" class="anchor"></a><code><span class="keyword">val</span> buf_ops : <span>Tjr_fs_shared__.Buf_factory.Buf_as_bigarray.ba_buf Tjr_fs_shared__Buffers_from_btree.buf_ops</span></code></dt><dt class="spec value" id="val-run"><a href="#val-run" class="anchor"></a><code><span class="keyword">val</span> run : unit <span>&#45;&gt;</span> <span><span>(unit, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt></dl></div></body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Stage_2 (tjr_impfs.Tjr_impfs.V2.Stage_1.Stage_2)</title><link rel="stylesheet" href="../../../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../../../index.html">tjr_impfs</a> &#x00BB; <a href="../../../index.html">Tjr_impfs</a> &#x00BB; <a href="../../index.html">V2</a> &#x00BB; <a href="../index.html">Stage_1</a> &#x00BB; Stage_2</nav><h1>Module <code>Stage_1.Stage_2</code></h1><nav class="toc"><ul><li><a href="#blk-allocator-using-freelist">Blk allocator using freelist</a></li><li><a href="#the-global-object-map-(gom)">The global object map (GOM)</a></li><li><a href="#dirs">Dirs</a></li></ul></nav></header><h3 class="heading">Parameters</h3><ul><li><code><a href="argument-1-S2/index.html">S2</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></li></ul><h3 class="heading">Signature</h3><section><header><h3 id="blk-allocator-using-freelist"><a href="#blk-allocator-using-freelist" class="anchor"></a>Blk allocator using freelist</h3></header><dl><dt class="spec value" id="val-blk_alloc"><a href="#val-blk_alloc" class="anchor"></a><code><span class="keyword">val</span> blk_alloc : <span><span>(Tjr_fs_shared.Shared_ctxt.r, <a href="../../S0/index.html#type-t">S0.t</a>)</span> Tjr_fs_shared.blk_allocator_ops</span></code></dt><dt class="spec value" id="val-freelist_ops"><a href="#val-freelist_ops" class="anchor"></a><code><span class="keyword">val</span> freelist_ops : <span><span>(Tjr_fs_shared.Shared_ctxt.r, <a href="../../S0/index.html#type-t">S0.t</a>)</span> Tjr_fs_shared.blk_allocator_ops</span></code></dt></dl></section><section><header><h3 id="the-global-object-map-(gom)"><a href="#the-global-object-map-(gom)" class="anchor"></a>The global object map (GOM)</h3></header><aside><p>NOTE FIXME this should really track the blocks it uses, as files and directories do; so the GOM has its own origin block, with a pointer to the root and a pointer to the used list</p></aside><dl><dt class="spec value" id="val-gom"><a href="#val-gom" class="anchor"></a><code><span class="keyword">val</span> gom : &lt; get_btree_root : unit <span>&#45;&gt;</span> <span><span>(<a href="../../../V2_gom/S/index.html#type-r">V2_gom.S.r</a>, <a href="../../../V2_gom/S/index.html#type-t">V2_gom.S.t</a>)</span> Tjr_monad.m</span>; map_ops_with_ls : <span><span>(<a href="../../../V2_gom/Dir_entry/index.html#type-t">V2_gom.Dir_entry.t</a>, <a href="../../../V2_gom/S/index.html#type-v">V2_gom.S.v</a>, <a href="../../../V2_gom/S/index.html#type-r">V2_gom.S.r</a>, <a href="../../../V2_gom/T/index.html#type-ls">V2_gom.T.ls</a>, <a href="../../../V2_gom/S/index.html#type-t">V2_gom.S.t</a>)</span> Tjr_btree__.Btree_intf.map_ops_with_ls</span>; &gt;</code></dt><dt class="spec value" id="val-gom_ops"><a href="#val-gom_ops" class="anchor"></a><code><span class="keyword">val</span> gom_ops : <span><span>(<a href="../../../V2_gom/Dir_entry/index.html#type-t">V2_gom.Dir_entry.t</a>, <a href="../../../V2_gom/S/index.html#type-v">V2_gom.S.v</a>, <a href="../../../V2_gom/S/index.html#type-r">V2_gom.S.r</a>, <a href="../../../V2_gom/T/index.html#type-ls">V2_gom.T.ls</a>, <a href="../../../V2_gom/S/index.html#type-t">V2_gom.S.t</a>)</span> Tjr_btree__.Btree_intf.map_ops_with_ls</span></code></dt><dt class="spec value" id="val-gom_find"><a href="#val-gom_find" class="anchor"></a><code><span class="keyword">val</span> gom_find : <span>k:<a href="../../../V2_gom/Dir_entry/index.html#type-t">V2_gom.Dir_entry.t</a></span> <span>&#45;&gt;</span> <span><span>(<span><a href="../../../V2_gom/S/index.html#type-v">V2_gom.S.v</a> option</span>, <a href="../../../V2_gom/S/index.html#type-t">V2_gom.S.t</a>)</span> Tjr_monad.m</span></code></dt></dl></section><section><header><h3 id="dirs"><a href="#dirs" class="anchor"></a>Dirs</h3></header><dl><dt class="spec value" id="val-gom_find_opt"><a href="#val-gom_find_opt" class="anchor"></a><code><span class="keyword">val</span> gom_find_opt : <span>k:<a href="../../../V2_gom/Dir_entry/index.html#type-t">V2_gom.Dir_entry.t</a></span> <span>&#45;&gt;</span> <span><span>(<span><a href="../../../V2_gom/S/index.html#type-v">V2_gom.S.v</a> option</span>, <a href="../../../V2_gom/S/index.html#type-t">V2_gom.S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-gom_find"><a href="#val-gom_find" class="anchor"></a><code><span class="keyword">val</span> gom_find : <a href="../../../V2_gom/Dir_entry/index.html#type-t">V2_gom.Dir_entry.t</a> <span>&#45;&gt;</span> <span><span>(<a href="../../../V2_gom/S/index.html#type-v">V2_gom.S.v</a>, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-gom_insert"><a href="#val-gom_insert" class="anchor"></a><code><span class="keyword">val</span> gom_insert : <span>k:<a href="../../../V2_gom/Dir_entry/index.html#type-t">V2_gom.Dir_entry.t</a></span> <span>&#45;&gt;</span> <span>v:<a href="../../../V2_gom/S/index.html#type-v">V2_gom.S.v</a></span> <span>&#45;&gt;</span> <span><span>(unit, <a href="../../../V2_gom/S/index.html#type-t">V2_gom.S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-gom_delete"><a href="#val-gom_delete" class="anchor"></a><code><span class="keyword">val</span> gom_delete : <span>k:<a href="../../../V2_gom/Dir_entry/index.html#type-t">V2_gom.Dir_entry.t</a></span> <span>&#45;&gt;</span> <span><span>(unit, <a href="../../../V2_gom/S/index.html#type-t">V2_gom.S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-dir_impl"><a href="#val-dir_impl" class="anchor"></a><code><span class="keyword">val</span> dir_impl : <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, <a href="../../../Dir_impl/Dir_entry/index.html#type-t">Dir_impl.Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.t, <a href="../../../Dir_impl/Dir_entry/index.html#type-did">Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Dir_impl/index.html#type-dir_factory">Dir_impl.dir_factory</a></span></code></dt><dt class="spec value" id="val-dir_impl'"><a href="#val-dir_impl'" class="anchor"></a><code><span class="keyword">val</span> dir_impl' : &lt; alloc_via_usedlist : <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Usedlist_impl/Usedlist/index.html#type-ops">Usedlist_impl.Usedlist.ops</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_fs_shared.blk_allocator_ops</span>; create_dir : <span>parent:<a href="../../../Dir_impl/Dir_entry/index.html#type-did">Dir_impl.Dir_entry.did</a></span> <span>&#45;&gt;</span> <span>times:<a href="../../../Dir_impl/index.html#type-stat_times">Dir_impl.stat_times</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; dir_add_autosync : Tjr_fs_shared.Shared_ctxt.r <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.str_256, <a href="../../../Dir_impl/Dir_entry/index.html#type-t">Dir_impl.Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t, <a href="../../../Dir_impl/Dir_entry/index.html#type-did">Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Dir_impl/Dir_ops/index.html#type-t">Dir_impl.Dir_ops.t</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.str_256, <a href="../../../Dir_impl/Dir_entry/index.html#type-t">Dir_impl.Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t, <a href="../../../Dir_impl/Dir_entry/index.html#type-did">Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Dir_impl/Dir_ops/index.html#type-t">Dir_impl.Dir_ops.t</a></span>; dir_from_origin : Tjr_fs_shared.Shared_ctxt.r <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.str_256, <a href="../../../Dir_impl/Dir_entry/index.html#type-t">Dir_impl.Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t, <a href="../../../Dir_impl/Dir_entry/index.html#type-did">Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Dir_impl/Dir_ops/index.html#type-t">Dir_impl.Dir_ops.t</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; dir_from_origin_blk : <span>(Tjr_fs_shared.Shared_ctxt.r * <span><span>(Tjr_fs_shared.Shared_ctxt.r, <a href="../../../Dir_impl/Dir_entry/index.html#type-did">Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Dir_impl/Dir_origin/index.html#type-t">Dir_impl.Dir_origin.t</a></span>)</span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.str_256, <a href="../../../Dir_impl/Dir_entry/index.html#type-t">Dir_impl.Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t, <a href="../../../Dir_impl/Dir_entry/index.html#type-did">Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Dir_impl/Dir_ops/index.html#type-t">Dir_impl.Dir_ops.t</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; mk_dir : <span>usedlist:<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Usedlist_impl/Usedlist/index.html#type-ops">Usedlist_impl.Usedlist.ops</a></span></span> <span>&#45;&gt;</span> <span>btree_root:Tjr_fs_shared.Shared_ctxt.r</span> <span>&#45;&gt;</span> <span>with_dir:<span><span>(<span><a href="../../../Dir_impl/Dir_entry/index.html#type-did">Dir_impl.Dir_entry.did</a> <a href="../../../Dir_impl/Dir_im/index.html#type-dir_im">Dir_impl.Dir_im.dir_im</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.with_state</span></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.str_256, <a href="../../../Dir_impl/Dir_entry/index.html#type-t">Dir_impl.Dir_entry.t</a>, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t, <a href="../../../Dir_impl/Dir_entry/index.html#type-did">Dir_impl.Dir_entry.did</a>)</span> <a href="../../../Dir_impl/Dir_ops/index.html#type-t">Dir_impl.Dir_ops.t</a></span>; usedlist_ops : <span>Tjr_fs_shared.Shared_ctxt.r <a href="../../../Usedlist_impl/Usedlist/index.html#type-origin">Usedlist_impl.Usedlist.origin</a></span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Usedlist_impl/Usedlist/index.html#type-ops">Usedlist_impl.Usedlist.ops</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; &gt;</code></dt><dt class="spec value" id="val-dirs"><a href="#val-dirs" class="anchor"></a><code><span class="keyword">val</span> dirs : <a href="../../Make/S1/index.html#type-dirs_ops">S1.dirs_ops</a></code></dt><dt class="spec value" id="val-file_impl"><a href="#val-file_impl" class="anchor"></a><code><span class="keyword">val</span> file_impl : <span><span>(Tjr_fs_shared.ba_buf, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../File_impl_v2/index.html#type-file_factory">File_impl_v2.file_factory</a></span></code></dt><dt class="spec value" id="val-file_impl'"><a href="#val-file_impl'" class="anchor"></a><code><span class="keyword">val</span> file_impl' : &lt; alloc_via_usedlist : <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Fv2_types/Usedlist/index.html#type-ops">Fv2_types.Usedlist.ops</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_fs_shared.blk_allocator_ops</span>; create_file : <a href="../../../Fv2_types/index.html#type-stat_times">Fv2_types.stat_times</a> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; file_from_origin : Tjr_fs_shared.Shared_ctxt.r <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../File_impl_v2/index.html#type-file_ops">File_impl_v2.file_ops</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; file_from_origin_blk : <span>(Tjr_fs_shared.Shared_ctxt.r * <span>Tjr_fs_shared.Shared_ctxt.r <a href="../../../File_impl_v2/File_origin_block/index.html#type-t">File_impl_v2.File_origin_block.t</a></span>)</span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../File_impl_v2/index.html#type-file_ops">File_impl_v2.file_ops</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; file_ops : <span>usedlist:<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Fv2_types/Usedlist/index.html#type-ops">Fv2_types.Usedlist.ops</a></span></span> <span>&#45;&gt;</span> <span>alloc_via_usedlist:<span>(unit <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>)</span></span> <span>&#45;&gt;</span> <span>blk_idx_map:<span><span>(int, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Fv2_types/Btree_ops/index.html#type-t">Fv2_types.Btree_ops.t</a></span></span> <span>&#45;&gt;</span> <span>file_origin:Tjr_fs_shared.Shared_ctxt.r</span> <span>&#45;&gt;</span> <span>init_file_size:int</span> <span>&#45;&gt;</span> <span>init_times:<a href="../../../Fv2_types/index.html#type-stat_times">Fv2_types.stat_times</a></span> <span>&#45;&gt;</span> <span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.ba_buf, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../File_impl_v2/index.html#type-file_ops">File_impl_v2.file_ops</a></span>; mk_blk_idx_map : <span>usedlist:<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Fv2_types/Usedlist/index.html#type-ops">Fv2_types.Usedlist.ops</a></span></span> <span>&#45;&gt;</span> <span>btree_root:Tjr_fs_shared.Shared_ctxt.r</span> <span>&#45;&gt;</span> <span><span>(int, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Fv2_types/Btree_ops/index.html#type-t">Fv2_types.Btree_ops.t</a></span>; usedlist_ops : <span>Tjr_fs_shared.Shared_ctxt.r <a href="../../../Fv2_types/Usedlist/index.html#type-origin">Fv2_types.Usedlist.origin</a></span> <span>&#45;&gt;</span> <span><span>(<span><span>(Tjr_fs_shared.Shared_ctxt.r, Tjr_fs_shared.Shared_ctxt.t)</span> <a href="../../../Fv2_types/Usedlist/index.html#type-ops">Fv2_types.Usedlist.ops</a></span>, Tjr_fs_shared.Shared_ctxt.t)</span> Tjr_monad.m</span>; &gt;</code></dt><dt class="spec value" id="val-files"><a href="#val-files" class="anchor"></a><code><span class="keyword">val</span> files : <a href="../../Make/S1/index.html#type-files_ops">S1.files_ops</a></code></dt></dl></section></div></body></html>
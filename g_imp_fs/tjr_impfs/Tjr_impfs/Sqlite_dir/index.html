<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sqlite_dir (tjr_impfs.Tjr_impfs.Sqlite_dir)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">tjr_impfs</a> &#x00BB; <a href="../index.html">Tjr_impfs</a> &#x00BB; Sqlite_dir</nav><h1>Module <code>Tjr_impfs.Sqlite_dir</code></h1></header><aside><p>An implementation of directories on top of sqlite, for v3.</p><p>To implement directories, we need to implement the interface:</p><pre><code class="ml">type ('k,'v,'t,'did) lower_ops = {
  get_meta  : unit -&gt; ('did * times,'t)m;
  (** returns parent and times *)

  find      : 'k -&gt; ('v option,'t) m;

  exec      : ('k,'v,'t,'did) exec_ops -&gt; (unit,'t)m;

  opendir   : unit -&gt; (('k,'v,'t)Ls.ops,'t)m;

  (* sync : unit -&gt; (unit,'t)m; NOTE we assume the lower layer already
     handles these synchronously *)
}</code></pre><p>We implement this without a cache: all operations go directly to the database.</p><p>Let's assume that each directory has a unique (int) identifier did.</p><p>Then we can have a single table dir_entries:</p><p>(did, name, entry)</p><p>Indexed by did,name (name is unique of course, for a particular did)</p><p>find, insert and delete are fine.</p><p>For parent and times, we can have another table (did,parent,times).</p><p>opendir creates a reference which pulls upto some limit of elts from the db, and stores the max name so we can resume later on ls_step.</p><p>FIXME what is the distinction between flush and sync at the lower layer? since these both force dirty changes to db, there isn't any</p></aside><div class="spec module" id="module-Times"><a href="#module-Times" class="anchor"></a><code><span class="keyword">module</span> Times = Tjr_minifs.Minifs_intf.Times</code></div><div class="spec module" id="module-List"><a href="#module-List" class="anchor"></a><code><span class="keyword">module</span> <a href="List/index.html">List</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include</span> <span class="keyword">sig</span> ... <span class="keyword">end</span></code></span></summary><dl><dt class="spec type" id="type-dir_ops"><a href="#type-dir_ops" class="anchor"></a><code><span class="keyword">type</span> <span>('k, 'v, 't, 'did) dir_ops</span></code><code> = <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="../Dv3/index.html#type-lower_ops">Dv3.lower_ops</a></span></code><code> = </code><code>{</code><table class="record"><tr id="type-dir_ops.get_meta" class="anchored"><td class="def field"><a href="#type-dir_ops.get_meta" class="anchor"></a><code>get_meta : unit <span>&#45;&gt;</span> <span><span>(<span class="type-var">'did</span> * <a href="../Dv3/index.html#type-times">Dv3.times</a>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>;</code></td></tr><tr id="type-dir_ops.find" class="anchored"><td class="def field"><a href="#type-dir_ops.find" class="anchor"></a><code>find : <span class="type-var">'k</span> <span>&#45;&gt;</span> <span><span>(<span><span class="type-var">'v</span> option</span>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>;</code></td></tr><tr id="type-dir_ops.exec" class="anchored"><td class="def field"><a href="#type-dir_ops.exec" class="anchor"></a><code>exec : <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'t</span>, <span class="type-var">'did</span>)</span> <a href="../Dv3/Op/index.html#type-exec_ops">Dv3.Op.exec_ops</a></span> <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>;</code></td></tr><tr id="type-dir_ops.opendir" class="anchored"><td class="def field"><a href="#type-dir_ops.opendir" class="anchor"></a><code>opendir : unit <span>&#45;&gt;</span> <span><span>(<span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'t</span>)</span> <a href="../Dv3/Ls/index.html#type-ops">Dv3.Ls.ops</a></span>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>;</code></td></tr></table><code>}</code></dt></dl></details></div></div></div><dl><dt class="spec type" id="type-times"><a href="#type-times" class="anchor"></a><code><span class="keyword">type</span> times</code><code> = <a href="index.html#module-Times">Times</a>.times</code></dt><dt class="spec type" id="type-cached_update"><a href="#type-cached_update" class="anchor"></a><code><span class="keyword">type</span> <span>'a cached_update</span></code><code> = </code><table class="variant"><tr id="type-cached_update.Some_" class="anchored"><td class="def constructor"><a href="#type-cached_update.Some_" class="anchor"></a><code>| </code><code><span class="constructor">Some_</span> <span class="keyword">of</span> <span class="type-var">'a</span></code></td></tr><tr id="type-cached_update.Deleted" class="anchored"><td class="def constructor"><a href="#type-cached_update.Deleted" class="anchor"></a><code>| </code><code><span class="constructor">Deleted</span></code></td></tr></table></dt><dt class="spec type" id="type-db"><a href="#type-db" class="anchor"></a><code><span class="keyword">type</span> db</code><code> = Sqlite3.db</code></dt></dl><dl><dt class="spec value" id="val-create_db_stmt"><a href="#val-create_db_stmt" class="anchor"></a><code><span class="keyword">val</span> create_db_stmt : string</code></dt></dl><dl><dt class="spec value" id="val-assert_ok"><a href="#val-assert_ok" class="anchor"></a><code><span class="keyword">val</span> assert_ok : Sqlite3.Rc.t <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-readdir_limit"><a href="#val-readdir_limit" class="anchor"></a><code><span class="keyword">val</span> readdir_limit : int</code></dt></dl><div class="spec module" id="module-Make"><a href="#module-Make" class="anchor"></a><code><span class="keyword">module</span> <a href="Make/index.html">Make</a> : <span class="keyword">functor</span> (<a href="Make/argument-1-S/index.html">S</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span>) <span>&#45;&gt;</span> <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Test"><a href="#module-Test" class="anchor"></a><code><span class="keyword">module</span> <a href="Test/index.html">Test</a> : <span class="keyword">functor</span> () <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></div></body></html>
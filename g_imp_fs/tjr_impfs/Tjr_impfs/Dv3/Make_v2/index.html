<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Make_v2 (tjr_impfs.Tjr_impfs.Dv3.Make_v2)</title><link rel="stylesheet" href="../../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../../index.html">tjr_impfs</a> &#x00BB; <a href="../../index.html">Tjr_impfs</a> &#x00BB; <a href="../index.html">Dv3</a> &#x00BB; Make_v2</nav><h1>Module <code>Dv3.Make_v2</code></h1><p>Like Make_v1, but assume that the lower layer supports an exec(ops) operation, rather than individual operations, since we typically flush batches of operations</p></header><h3 class="heading">Parameters</h3><ul><li><code><a href="argument-1-S/index.html">S</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></li></ul><h3 class="heading">Signature</h3><dl><dt class="spec value" id="val-(&gt;&gt;=)"><a href="#val-(&gt;&gt;=)" class="anchor"></a><code><span class="keyword">val</span> (&gt;&gt;=) : <span><span>(<span class="type-var">'a</span>, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span> <span>&#45;&gt;</span> <span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'b</span>, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span>)</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'b</span>, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-return"><a href="#val-return" class="anchor"></a><code><span class="keyword">val</span> return : <span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-get_times"><a href="#val-get_times" class="anchor"></a><code><span class="keyword">val</span> get_times : unit <span>&#45;&gt;</span> <span><span>(<a href="../index.html#type-times">times</a>, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-set_times"><a href="#val-set_times" class="anchor"></a><code><span class="keyword">val</span> set_times : <a href="../index.html#type-times">times</a> <span>&#45;&gt;</span> <span><span>(unit, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-get_parent"><a href="#val-get_parent" class="anchor"></a><code><span class="keyword">val</span> get_parent : unit <span>&#45;&gt;</span> <span><span>(<a href="argument-1-S/index.html#type-did">S.did</a>, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-set_parent"><a href="#val-set_parent" class="anchor"></a><code><span class="keyword">val</span> set_parent : <a href="argument-1-S/index.html#type-did">S.did</a> <span>&#45;&gt;</span> <span><span>(unit, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-find"><a href="#val-find" class="anchor"></a><code><span class="keyword">val</span> find : <a href="argument-1-S/index.html#type-k">S.k</a> <span>&#45;&gt;</span> <span><span>(<span><a href="argument-1-S/index.html#type-v">S.v</a> option</span>, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-lower_insert_sync"><a href="#val-lower_insert_sync" class="anchor"></a><code><span class="keyword">val</span> lower_insert_sync : <span><span>(<a href="argument-1-S/index.html#type-k">S.k</a> * <span><a href="argument-1-S/index.html#type-v">S.v</a> <a href="../index.html#type-cache_entry">cache_entry</a></span>)</span> list</span> <span>&#45;&gt;</span> <span><span>(unit, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-maybe_trim"><a href="#val-maybe_trim" class="anchor"></a><code><span class="keyword">val</span> maybe_trim : <span>state:<span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>)</span> <a href="../index.html#type-d_cache">d_cache</a></span></span> <span>&#45;&gt;</span> <span>set_state:<span>(<span><span>(<span class="type-var">'a</span>, <a href="argument-1-S/index.html#type-cache">S.cache</a>)</span> <a href="../index.html#type-d_cache">d_cache</a></span> <span>&#45;&gt;</span> <span><span>(unit, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span>)</span></span> <span>&#45;&gt;</span> <span>cache:<a href="argument-1-S/index.html#type-cache">S.cache</a></span> <span>&#45;&gt;</span> <span><span>(unit, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-insert"><a href="#val-insert" class="anchor"></a><code><span class="keyword">val</span> insert : <a href="argument-1-S/index.html#type-k">S.k</a> <span>&#45;&gt;</span> <a href="argument-1-S/index.html#type-v">S.v</a> <span>&#45;&gt;</span> <span><span>(unit, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-delete"><a href="#val-delete" class="anchor"></a><code><span class="keyword">val</span> delete : <a href="argument-1-S/index.html#type-k">S.k</a> <span>&#45;&gt;</span> <span><span>(unit, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-flush"><a href="#val-flush" class="anchor"></a><code><span class="keyword">val</span> flush : unit <span>&#45;&gt;</span> <span><span>(unit, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-sync"><a href="#val-sync" class="anchor"></a><code><span class="keyword">val</span> sync : unit <span>&#45;&gt;</span> <span><span>(unit, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt></dl><aside><p>The ls operation (&quot;leaf stream&quot;) is used to implement readdir. We have a lower uncached implementation, the cache contents, and we need to implement the cached version.</p><p>Cache entries are: Some _ | Deleted | Not_present</p><p>These entries can be dirty or clean (Not_present is always clean).</p><p>A stupid implementation would just flush to lower, and then use the lower operations (since the cache is now clean).</p><p>let ls_create () = flush () &gt;&gt;= fun () -&gt; lower_ops.ls_create ()</p><p>This is clearly suboptimal, since we shouldn't HAVE to flush to lower, and this operation is potentially costly.</p><p>How to implement the cached version of ls? We can ignore Not_present. For deleted cache entries, we must make sure to filter the relevant (k,v) entries from the lower ls.</p><p>What to do with new Some entries? There are two obvious implementations:</p><p>1) Return all new entries in the first call to ls_kvs(); ls_step() then reverts to the (filtered) entries from lower 2) Attempt to return new entries as we iterate over lower entries via lower.ls_step()</p><p>Option 1 is ugly because it reveals the cache contents, and potentially destroys whatever order the lower layer may provide (eg lexicographic on names... not that POSIX requires such an order of course).</p><p>Option 2 is somewhat complicated. The issue is where to put new entries that might appear in one of two possible chunks. For example, suppose the first chunk contains keys <code>1,2,3</code> and the next (after ls_step()) contains <code>5,6,7</code>. Where should we put an entry with key 4? To include in the first chunk we need to know that the next chunk does not contain a key 4, which requires reading the next chunk in advance, which is a bit ugly. To include in the second chunk is possible, and avoids the reading ahead. Potentially this requires an extra chunk at the end.</p><p>An alternative, if we knew the bounds for a particular chunk (k1 &lt;= ... &lt; k2), would be straightforward - we just include the new entry in the correct chunk.</p><p>Ideally we would alter the ls operations to return the bound, and implement the straightforward approach. Rather than go back and alter the ls interface (again!) we hack something together here based on option 1.</p></aside><dl><dt class="spec value" id="val-opendir"><a href="#val-opendir" class="anchor"></a><code><span class="keyword">val</span> opendir : unit <span>&#45;&gt;</span> <span><span>(<span><span>(<a href="argument-1-S/index.html#type-k">S.k</a>, <a href="argument-1-S/index.html#type-v">S.v</a>, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> <a href="../Ls/index.html#type-ops">Ls.ops</a></span>, <a href="argument-1-S/index.html#type-t">S.t</a>)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-dir_ops"><a href="#val-dir_ops" class="anchor"></a><code><span class="keyword">val</span> dir_ops : <span><span>(<a href="argument-1-S/index.html#type-k">S.k</a>, <a href="argument-1-S/index.html#type-v">S.v</a>, <a href="argument-1-S/index.html#type-t">S.t</a>, <a href="argument-1-S/index.html#type-did">S.did</a>)</span> <a href="../Dir/index.html#type-dir_ops">Dir.dir_ops</a></span></code></dt></dl></div></body></html>